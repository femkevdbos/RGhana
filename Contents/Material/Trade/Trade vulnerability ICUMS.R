---
title: "GSS Trade vulnerability ICUMS"
author: "Femke van den Bos"
lastchanged: "13-02-2023"
output: "Trade data" 
---
  
# Setup
{
    library(tidyverse)
    library(xts)
    library(zoo)
    library(tidyr)
    library(plotly)
    library(ggrepel)
    library(fuzzyjoin)
    library(readxl)
    library(stringr)
    library(openxlsx)
    library(lubridate)
    library(janitor)
    library(rio)
    library(gghighlight)
    library(data.table)
    library(writexl)
    #library(xlsx)
    Sys.setlocale("LC_TIME", "English") 
    # Need to do this do NOT have scientific notation
    options(scipen = 10)
    
    # Create blank theme
    blank_theme <- theme_minimal()+
      theme(
        #axis.title.x = element_blank(),
        #axis.title.y = element_blank(),
        panel.border = element_blank(),
        panel.grid=element_blank(),
        plot.title = element_text(hjust = 0.5)
        #axis.ticks = element_blank(),
        #plot.title=element_text(size=14, face="bold") 
      )
    
    blank_theme2 <- theme_minimal()+
      theme(
        #axis.title.x = element_blank(),
        #axis.title.y = element_blank(),
        panel.border = element_blank(),
        #panel.grid=element_blank(),
        plot.title = element_text(hjust = 0.5)
        #axis.ticks = element_blank(),
        #plot.title=element_text(size=14, face="bold") 
      )
}

###################################
############## 2022 ###############
###################################

# Read 2022 Icums data - OR LOAD DATA DIRECTLY FROM R WORKSPACE!!!
{
    # Path for all data files 
    pathname_icums_22 <- "data/raw_data/ICUMS DATA 2022"
    # File list of all files in 2022 data
    icums_file_list_22 <- list.files(pathname_icums_22)
    
    ### Read Import ###
    # Create file list
    icums_import_file_list_22 <- icums_file_list_22[grepl("Merchandised Import", icums_file_list_22)]
    # Make list of all excel sheets
    import_icums_22 <- lapply(icums_import_file_list_22, function(x) { # This function loops over all files
      sheets <- readxl::excel_sheets(paste(pathname_icums_22, x, sep = "/")) # Per file it gives us a list of sheet names
      lapply(sheets, function(y) { # This function then loops over all sheets
        readxl::read_excel(paste(pathname_icums_22, x, sep = "/"), 
                           sheet = y, 
                           col_names = TRUE, skip = 4)
        })
    })
    
    # Now make into dataframe, by unlisting and binding rows
    import_icums_22_list <- unlist(import_icums_22, recursive = FALSE)
    import_icums_22_input <- do.call("bind_rows", import_icums_22_list)
    
    ### Read Re-Import ###
    # Create file list
    icums_re_import_file_list_22 <- icums_file_list_22[grepl("Merchandised Re-Import", icums_file_list_22)]
    # Make list of all excel sheets
    re_import_icums_22 <- lapply(icums_re_import_file_list_22, function(x) { # This function loops over all files
      sheets <- readxl::excel_sheets(paste(pathname_icums_22, x, sep = "/")) # Per file it gives us a list of sheet names
      lapply(sheets, function(y) { # This function then loops over all sheets
        readxl::read_excel(paste(pathname_icums_22, x, sep = "/"),
                           sheet = y, 
                           col_names = TRUE, skip = 4)
        })
    })
    
    # Now make into dataframe, by unlisting and binding rows
    re_import_icums_22_list <- unlist(re_import_icums_22, recursive = FALSE)
    re_import_icums_22_input <- do.call("bind_rows", re_import_icums_22_list)
    
    ### Read Warehousing ###
    # Create file list
    icums_wh_file_list_22 <- icums_file_list_22[grepl("Warehousing", icums_file_list_22)]
    # Make list of all excel sheets
    wh_icums_22 <- lapply(icums_wh_file_list_22, function(x) { # This function loops over all files
      sheets <- readxl::excel_sheets(paste(pathname_icums_22, x, sep = "/")) # Per file it gives us a list of sheet names
      lapply(sheets, function(y) { # This function then loops over all sheets
        readxl::read_excel(paste(pathname_icums_22, x, sep = "/"), 
                           sheet = y, 
                           col_names = TRUE, skip = 4)
        })
    })
    
    # Now make into dataframe, by unlisting and binding rows
    wh_icums_22_list <- unlist(wh_icums_22, recursive = FALSE)
    wh_icums_22_input <- do.call("bind_rows", wh_icums_22_list)
    
    
    ### Read Regime 9 ###
    # Pathname reg 9
    pathname_icums_reg9 <- "data/raw_data/REGIME 9"
    # File list of all files of regime 9
    icums_reg9_file_list <- list.files(pathname_icums_reg9)
    # Create file list
    icums_reg9_file_list_22 <- icums_reg9_file_list[grepl("2022", icums_reg9_file_list)]
    # Make list of all excel sheets
    reg9_icums_22 <- lapply(icums_reg9_file_list_22, function(x) { # This function loops over all files
      sheets <- readxl::excel_sheets(paste(pathname_icums_reg9, x, sep = "/")) # Per file it gives us a list of sheet names
      lapply(sheets, function(y) { # This function then loops over all sheets
        readxl::read_excel(paste(pathname_icums_reg9, x, sep = "/"), 
                           sheet = y, 
                           col_names = TRUE, skip = 5)
      })
    })
    
    # Now make into dataframe, by unlisting and binding rows
    reg9_icums_22_list <- unlist(reg9_icums_22, recursive = FALSE)
    reg9_icums_22_input <- do.call("bind_rows", reg9_icums_22_list)
    
    
    ### Read Export ###
    # Create file list
    icums_export_file_list_22 <- icums_file_list_22[grepl("Merchandised Export", icums_file_list_22)]
    # Make list of all excel sheets
    export_icums_22 <- lapply(icums_export_file_list_22, function(x) { # This function loops over all files
      sheets <- readxl::excel_sheets(paste(pathname_icums_22, x, sep = "/")) # Per file it gives us a list of sheet names
      lapply(sheets, function(y) { # This function then loops over all sheets
        readxl::read_excel(paste(pathname_icums_22, x, sep = "/"), 
                           sheet = y, 
                           col_names = TRUE, skip = 4)
        })
    })
    
    # Now make into dataframe, by unlisting and binding rows
    export_icums_22_list <- unlist(export_icums_22, recursive = FALSE)
    export_icums_22_input <- do.call("bind_rows", export_icums_22_list)
    
    ### Read Re-Export ###
    # Create file list
    icums_re_export_file_list_22 <- icums_file_list_22[grepl("Merchandised Re-Export", icums_file_list_22)]
    # Make list of all excel sheets
    re_export_icums_22 <- lapply(icums_re_export_file_list_22, function(x) { # This function loops over all files
      sheets <- readxl::excel_sheets(paste(pathname_icums_22, x, sep = "/")) # Per file it gives us a list of sheet names
      lapply(sheets, function(y) { # This function then loops over all sheets
        readxl::read_excel(paste(pathname_icums_22, x, sep = "/"), 
                           sheet = y, 
                           col_names = TRUE, skip = 4)
        })
    })
    
    # Now make into dataframe, by unlisting and binding rows
    re_export_icums_22_list <- unlist(re_export_icums_22, recursive = FALSE)
    re_export_icums_22_input <- do.call("bind_rows", re_export_icums_22_list)
    
    ### Drop dataframes ###
    rm(pathname_icums_22, icums_file_list_22,
       icums_import_file_list_22, import_icums_22, import_icums_22_list,
       icums_re_import_file_list_22, re_import_icums_22, re_import_icums_22_list,
       icums_wh_file_list_22, wh_icums_22, wh_icums_22_list,
       pathname_icums_reg9, icums_reg9_file_list, icums_reg9_file_list_22, reg9_icums_22, reg9_icums_22_list,
       icums_export_file_list_22, export_icums_22, export_icums_22_list,
       icums_re_export_file_list_22, re_export_icums_22, re_export_icums_22_list)
}

# ALTERNATIVE = READ RAW FROM WORKSPACE!
{
  load("total/input/raw_icums_22.RData")
}

# Rename columns and select, same format for every type of input
{
  # Clean Import
  import_icums_22_clean <- import_icums_22_input %>%
  mutate(date = convert_to_date(HEAD_TIME_PROC, character_fun = lubridate::dmy),
         year = as.numeric(format(date, "%Y")),
         month = as.numeric(format(date, "%m")),
         month_name = month.name[month],
         day = as.numeric(format(date, "%d")),
         warehouse = 0,
         re = 0,
         reg9 = 0,
         tradeflow = "Import") %>%
    rename(hs_code = ITEMS_HS_CODE,
           country_abb = HEAD_COUNTRY_ORIG_DEST,
           country_cons = COUNTRY_OF_CONSIGNMENT,
           cif = ITEMS_CIF_GHC,
           fob = ITEMS_FOB_GHC,
           net_mass = ITEMS_NET_MASS,
           gross_mass = ITEMS_GROSS_MASS,
           desc = ITEMS_GOODS_DESC,
           head_cust_off = HEAD_CUST_OFF_CODE,
           head_decl_no = HEAD_DECL_NO,
           head_declarant_id = HEAD_DECLARANT_ID,
           head_declarant_name = HEAD_DECLARANT_NAME,
           head_porter_code = HEAD_IMPORTER_CODE,
           head_porter_name = HEAD_IMPORTER_NAME) %>%
    select(tradeflow, date, year, month, month_name, day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re, reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Clean Re-Import
  re_import_icums_22_clean <- re_import_icums_22_input %>%
    mutate(date = convert_to_date(HEAD_TIME_PROC, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 0,
           re = 1,
           reg9 = 0,
           tradeflow = "Import") %>%
    rename(hs_code = ITEMS_HS_CODE,
           country_abb = HEAD_COUNTRY_ORIG_DEST,
           country_cons = COUNTRY_OF_CONSIGNMENT,
           cif = ITEMS_CIF_GHC,
           fob = ITEMS_FOB_GHC,
           net_mass = ITEMS_NET_MASS,
           gross_mass = ITEMS_GROSS_MASS,
           desc = ITEMS_GOODS_DESC,
           head_cust_off = HEAD_CUST_OFF_CODE,
           head_decl_no = HEAD_DECL_NO,
           head_declarant_id = HEAD_DECLARANT_ID,
           head_declarant_name = HEAD_DECLARANT_NAME,
           head_porter_code = HEAD_IMPORTER_CODE,
           head_porter_name = HEAD_IMPORTER_NAME) %>%
    select(tradeflow, date, year, month, month_name, day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re, reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Clean Warehousing
  wh_icums_22_clean <- wh_icums_22_input %>%
    mutate(date = convert_to_date(BOE_ISSUE_DATE, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 1,
           re = 0,
           reg9 = 0,
           head_cust_off = NA,
           head_porter_code = NA,
           country_cons = COUNTRY_OF_SHIPMENT, # As no country of consignment, add it as country of shipment
           tradeflow = "Import") %>% 
    rename(hs_code = ITEMS_HS_CODE,
           country_abb = COUNTRY_OF_SHIPMENT,
           cif = ITEMS_CIF_GHC,
           fob = ITEMS_FOB_GHC,
           net_mass = ITEMS_NET_MASS,
           gross_mass = ITEMS_GROSS_MASS,
           desc = ITEMS_GOODS_DESC,
           head_declarant_id = HEAD_DECLARANT_ID,
           head_declarant_name = HEAD_DECLARANT_NAME,
           head_porter_name = HEAD_IMPORTER_NAME,
           head_decl_no = BOE_NUMBER) %>% # YES HEAD DECL = BOE NUMB
    select(tradeflow, date, year, month, month_name, day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re, reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Clean Regime 9
  reg9_icums_22_clean <- reg9_icums_22_input %>%
    mutate(date = convert_to_date(BOE_DECLARATION_DATE, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 0,
           re = 0,
           reg9 = 1,
           tradeflow = "Import",
           head_declarant_id = NA, # NOT IN DATA
           head_declarant_name = NA, # NOT IN DATA
           net_mass = NA # NOT IN DATA
           ) %>%
    rename(hs_code = ITEM_HS_CODE, # ITEM INSTEAD OF ITEMS
           country_abb = COUNTRY_OF_ORIGIN, #DIFF, FULL NAMES
           country_cons = COUNTRY_OF_CONSIGNMENT, # DIFF FULL NAMES
           cif = ITEM_CIF_GHS, # ITEM NOT S AND GHS NOT GHC
           fob = ITEM_FOB_GHS, # ITEM NOT S AND GHS NOT GHC
           gross_mass = ITEM_GROSS_WEIGHT_KG, # DIFF
           desc = ITEM_GOODS_DESCRIPTION, # DESCRIPTION INSTEAD OF DESC
           head_cust_off = CUSTOMS_CLEARANCE_OFFICE, # INSTEAD OF HEAD_CUST_OFF_CODE
           head_porter_code = IMPORTER_TIN, # MAYBE IMPORTER_TIN?
           head_porter_name = IMPORTER_NAME,# NO HEAD
           head_decl_no = BOE_NO) %>% # BOE NUMBER??
    select(tradeflow, date, year, month, month_name, day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re, reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Clean Export
  export_icums_22_clean <- export_icums_22_input %>%
    mutate(date = convert_to_date(HEAD_TIME_PROC, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 0,
           re = 0,
           reg9 = 0,
           tradeflow = "Export") %>%
    rename(hs_code = ITEMS_HS_CODE,
           country_abb = HEAD_COUNTRY_ORIG_DEST,
           country_cons = COUNTRY_OF_CONSIGNMENT,
           cif = ITEMS_CIF_GHC,
           fob = ITEMS_FOB_GHC,
           net_mass = ITEMS_NET_MASS,
           gross_mass = ITEMS_GROSS_MASS,
           desc = ITEMS_GOODS_DESC,
           head_cust_off = HEAD_CUST_OFF_CODE,
           head_decl_no = HEAD_DECL_NO,
           head_declarant_id = HEAD_DECLARANT_ID,
           head_declarant_name = HEAD_DECLARANT_NAME,
           head_porter_code = HEAD_EXPORTER_CODE,
           head_porter_name = HEAD_EXPORTER_NAME) %>%
    select(tradeflow, date, year, month, month_name, day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re, reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Clean Re-Export
  re_export_icums_22_clean <- re_export_icums_22_input %>%
    mutate(date = convert_to_date(HEAD_TIME_PROC, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 0,
           re = 1,
           reg9 = 0,
           tradeflow = "Export") %>%
    rename(hs_code = ITEMS_HS_CODE,
           country_abb = HEAD_COUNTRY_ORIG_DEST,
           country_cons = COUNTRY_OF_CONSIGNMENT,
           cif = ITEMS_CIF_GHC,
           fob = ITEMS_FOB_GHC,
           net_mass = ITEMS_NET_MASS,
           gross_mass = ITEMS_GROSS_MASS,
           desc = ITEMS_GOODS_DESC,
           head_cust_off = HEAD_CUST_OFF_CODE,
           head_decl_no = HEAD_DECL_NO,
           head_declarant_id = HEAD_DECLARANT_ID,
           head_declarant_name = HEAD_DECLARANT_NAME,
           head_porter_code = HEAD_EXPORTER_CODE,
           head_porter_name = HEAD_EXPORTER_NAME) %>%
    select(tradeflow, date, year, month, month_name,day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re,reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Drop raw dataframes
  rm(import_icums_22_input, re_import_icums_22_input, wh_icums_22_input,
     reg9_icums_22_input, export_icums_22_input, re_export_icums_22_input)
}

# ALTERNATIVE = READ CLEAN FROM WORKSPACE!
{
  load("total/input/raw_icums_22_clean.RData")
}

# First sanity checks
{
  ### Import checks ###
  {
    # Yearly totals
    yearly_sum_imp <- import_icums_22_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_imp
    
    # Summary statistics per month
    monthly_sum_imp <- import_icums_22_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_imp
    
    # Overview in table with top 10 cif each month
    top10_cif_month_import <- import_icums_22_clean %>%
      group_by(month) %>%
      arrange(-cif) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:10) %>%
      ungroup() %>%
      arrange(-cif)
    
    # Overview of 0 values CIF 
    cif_0_import <- import_icums_22_clean %>%
      filter(cif == 0) 
    
    # Make plot
    imp_top10_plot <-  ggplot(top10_cif_month_import,
                              aes(x = factor(month_name, levels = month.name), 
                                  y = cif, 
                                  fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Import, cif (in GHC)", fill = "Rank",
           title = "Monthly maximum single imports in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    imp_top10_plot
     
  }
  
  ### Re-Import checks ###
  {
    # Yearly totals
    yearly_sum_re_imp <- re_import_icums_22_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_re_imp
    
    # Summary statistics per month
    monthly_sum_re_imp <- re_import_icums_22_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_re_imp
    
    # Overview in table with top 10 cif each month
    top10_cif_month_re_import <- re_import_icums_22_clean %>%
      group_by(month) %>%
      arrange(-cif) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:10) %>%
      ungroup() %>%
      arrange(-cif)
    
    # Overview of 0 values CIF 
    cif_0_re_import <- re_import_icums_22_clean %>%
      filter(cif == 0) 
    
    # Make plot
    re_imp_top10_plot <- ggplot(top10_cif_month_re_import,
                                aes(x = factor(month_name, levels = month.name), 
                                    y = cif, 
                                    fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Re-Import, cif (in GHC)", fill = "Rank",
           title = "Monthly maximum single re-imports in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    re_imp_top10_plot
  }
  
  ### Warehousing checks ###
  {
    # Yearly totals
    yearly_sum_wh <- wh_icums_22_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_wh
    
    # Summary statistics per month
    monthly_sum_wh <- wh_icums_22_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_wh
    
    # Overview in table with top 10 cif each month
    top10_cif_month_wh <- wh_icums_22_clean %>%
      group_by(month) %>%
      arrange(-cif) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:10) %>%
      ungroup() %>%
      arrange(-cif)
    
    # Overview of 0 values CIF 
    cif_0_wh<- wh_icums_22_clean %>%
      filter(cif == 0) 

    # Make plot
    wh_top10_plot <- ggplot(top10_cif_month_wh,
                            aes(x = factor(month_name, levels = month.name), 
                                y = cif, 
                                fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Warehousing, cif (in GHC)", fill = "Rank",
           title = "Monthly maximum single warehousing in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    wh_top10_plot
  }
  
  ### Regime 9 checks ###
  {
    # Yearly totals
    yearly_sum_reg9 <- reg9_icums_22_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_reg9
    
    # Summary statistics per month
    monthly_sum_reg9 <- reg9_icums_22_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_reg9
    
    # Overview in table with top 10 cif each month
    top10_cif_month_reg9 <- reg9_icums_22_clean %>%
      group_by(month) %>%
      arrange(-cif) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:10) %>%
      ungroup() %>%
      arrange(-cif)
    
    # Overview of 0 values CIF 
    cif_0_reg9 <- reg9_icums_22_clean %>%
      filter(cif == 0) 
    
    # Make plot
   reg9_top10_plot <-  ggplot(top10_cif_month_reg9,
                              aes(x = factor(month_name, levels = month.name), 
                                  y = cif, 
                                  fill = factor(rank))) + 
     geom_bar(stat = "identity", position = "dodge") +
     blank_theme2 +
     labs(x = "Month", y = "Regime 9, cif (in GHC)", fill = "Rank",
          title = "Monthly maximum single regime 9 in Ghana") +
     theme(axis.text.x = element_text(angle = -90),
           legend.position = "none")
   
   reg9_top10_plot
   
  }
  
  ### Export checks ###
  {
    # Yearly totals
    yearly_sum_exp <- export_icums_22_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_exp
    
    # Summary statistics per month
    monthly_sum_exp <- export_icums_22_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_exp
    
    # Overview in table with top 20 cif each month
    top10_fob_month_export <- export_icums_22_clean %>%
      group_by(month) %>%
      arrange(-fob) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:10) %>%
      ungroup() %>%
      arrange(-fob)
    
    # Overview of 0 values fob 
    fob_0_export <- export_icums_22_clean %>%
      filter(fob == 0) 
    
    # Make plot
    exp_top10_plot <-  ggplot(filter(top10_fob_month_export, fob < 1000000000), # Note: filtered out the one extreme observation
                              aes(x = factor(month_name, levels = month.name), 
                                  y = fob, 
                                  fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Export, fob (in GHC)", fill = "Rank",
           title = "Monthly maximum single exports in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    exp_top10_plot <-  ggplot(top10_fob_month_export, # Note: filtered out the one extreme observation
                              aes(x = factor(month_name, levels = month.name), 
                                  y = fob, 
                                  fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Export, fob (in GHC)", fill = "Rank",
           title = "Monthly maximum single exports in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    exp_top10_plot
  }
  
  ### Re-Export checks ###
  {
    # Yearly totals
    yearly_sum_re_exp <- re_export_icums_22_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_re_exp
    
    # Summary statistics per month
    monthly_sum_re_exp <- re_export_icums_22_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_re_exp
    
    # Overview in table with top 20 cif each month
    top10_fob_month_re_export <- re_export_icums_22_clean %>%
      group_by(month) %>%
      arrange(-fob) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:10) %>%
      ungroup() %>%
      arrange(-fob)
    
    # Overview of 0 values FOB 
    fob_0_re_export <- re_export_icums_22_clean %>%
      filter(fob == 0) 
    
    # Make plot
    re_exp_top10_plot <- ggplot(top10_fob_month_re_export,
                                aes(x = factor(month_name, levels = month.name), 
                                    y = fob, 
                                    fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Re-Export, fob (in GHC)", fill = "Rank",
           title = "Monthly maximum single re-exports in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    re_exp_top10_plot
  }
  
  ### Save checks into Excel - top 10 per month ###
  {
    # Create workbook and fill with data and plots
    {
      wb <- createWorkbook()
      # Import
      # Create sheet
      imp_sheet <- addWorksheet(wb, "Import") 
      # Add dataframe
      writeData(wb, sheet = imp_sheet, top10_cif_month_import,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add plot
      imp_top10_plot
      insertPlot(wb, sheet = imp_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Re-import
      # Create sheet
      re_imp_sheet <- addWorksheet(wb, "Re-Import") 
      # Add dataframe
      writeData(wb, sheet = re_imp_sheet, top10_cif_month_re_import,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add plot
      re_imp_top10_plot
      insertPlot(wb, sheet = re_imp_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Warehousing
      # Create sheet
      wh_sheet <- addWorksheet(wb, "Warehousing") 
      # Add dataframe
      writeData(wb, sheet = wh_sheet, top10_cif_month_wh,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add plot
      wh_top10_plot
      insertPlot(wb, sheet = wh_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Regime 9
      # Create sheet
      reg9_sheet <- addWorksheet(wb, "Regime 9") 
      # Add dataframe
      writeData(wb, sheet = reg9_sheet, top10_cif_month_reg9,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add plot
      reg9_top10_plot
      insertPlot(wb, sheet = reg9_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Export
      # Create sheet
      exp_sheet <- addWorksheet(wb, "Export") 
      # Add dataframe
      writeData(wb, sheet = exp_sheet, top10_fob_month_export,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add plot
      exp_top10_plot
      insertPlot(wb, sheet = exp_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Re-Export
      # Create sheet
      re_exp_sheet <- addWorksheet(wb, "Re-Export") 
      # Add dataframe
      writeData(wb, sheet = re_exp_sheet, top10_fob_month_re_export,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add plot
      re_exp_top10_plot
      insertPlot(wb, sheet = re_exp_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Save workbook to excel
      saveWorkbook(wb, "total/output/ICUMS22_datacheck_top10.xlsx", overwrite = TRUE)
      
    }
  
    
  }
  
  ### Save checks into Excel - zero cif and fob values ###
  {
    # Create workbook and fill with data and plots
    {
      wb <- createWorkbook()
      # Import
      # Create sheet
      imp_sheet <- addWorksheet(wb, "Import") 
      # Add dataframe
      writeData(wb, sheet = imp_sheet, cif_0_import,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Re-import
      # Create sheet
      re_imp_sheet <- addWorksheet(wb, "Re-Import") 
      # Add dataframe
      writeData(wb, sheet = re_imp_sheet, cif_0_re_import,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Warehousing
      # Create sheet
      wh_sheet <- addWorksheet(wb, "Warehousing") 
      # Add dataframe
      writeData(wb, sheet = wh_sheet, cif_0_wh,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Regime 9
      # Create sheet
      reg9_sheet <- addWorksheet(wb, "Regime 9") 
      # Add dataframe
      writeData(wb, sheet = reg9_sheet, cif_0_reg9,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Export
      # Create sheet
      exp_sheet <- addWorksheet(wb, "Export") 
      # Add dataframe
      writeData(wb, sheet = exp_sheet, fob_0_export,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Re-Export
      # Create sheet
      re_exp_sheet <- addWorksheet(wb, "Re-Export") 
      # Add dataframe
      writeData(wb, sheet = re_exp_sheet, fob_0_re_export,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Save workbook to excel
      saveWorkbook(wb, "total/output/ICUMS22_cif_fob_0.xlsx", overwrite = TRUE)
      
    }
    
    
  }
}

# Remove outliers from data --> for now best option, need to consult with ICUMS (GhanaLink or customs?)
# And make monthly datasets
{
  # Import outlier removing
  {
    # Outlier removing
    import_icums_22_final <- import_icums_22_clean %>%
      filter(cif < 300000000)
    # Check new summary statistics
    monthly_sum_imp_new <- import_icums_22_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_imp_new
    
    # Create new dataset
    import_icums_22_month <- import_icums_22_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
    
  }
  
  # Re-Import outlier removing
  {
    # Outlier removing
    re_import_icums_22_final <- re_import_icums_22_clean %>%
      filter(cif < 300000000)
    # Check new summary statistics
    monthly_sum_re_imp_new <- re_import_icums_22_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_re_imp_new
    
    # Create new dataset
    re_import_icums_22_month <- re_import_icums_22_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  # Warehousing outlier removing
  {
    # Outlier removing
    wh_icums_22_final <- wh_icums_22_clean %>%
      filter(cif < 300000000)
    # Check new summary statistics
    monthly_sum_wh_new <- wh_icums_22_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_wh_new
    
    # Create new dataset
    wh_icums_22_month <- wh_icums_22_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  # Regime 9 outlier removing
  {
    # Outlier removing
    reg9_icums_22_final <- reg9_icums_22_clean %>%
      filter(cif < 300000000)
    # Check new summary statistics
    monthly_sum_reg9_new <- reg9_icums_22_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_reg9_new
    
    # Create new dataset
    reg9_icums_22_month <- reg9_icums_22_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  # Export outlier removing
  {
    # Outlier removing
    export_icums_22_final <- export_icums_22_clean %>%
      filter(cif < 300000000)
    # Check new summary statistics
    monthly_sum_exp_new <- export_icums_22_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_exp_new
    
    # Create new dataset
    export_icums_22_month <- export_icums_22_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  # Re-Export outlier removing
  {
    # Outlier removing
    re_export_icums_22_final <- re_export_icums_22_clean %>%
      filter(cif < 300000000)
    # Check new summary statistics
    monthly_sum_re_exp_new <- re_export_icums_22_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_re_exp_new
    
    # Create new dataset
    re_export_icums_22_month <- re_export_icums_22_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  
}

# ALTERNATIVE = READ TOTAL FROM WORKSPACE!
{
  load("total/input/icums_total_22.RData")
  
  
}

# Merge import, re_import, warehousing, reg9, export, re_export all together
{
  # Merge all data
  icums_total_22 <- rbind(import_icums_22_final,
                          re_import_icums_22_final,
                          wh_icums_22_final,
                          reg9_icums_22_final,
                          export_icums_22_final,
                          re_export_icums_22_final)
  
  # Check totals
  # Import
  total_imp <- icums_total_22 %>%
    filter(tradeflow == "Import",
           re == 0,
           warehouse == 0,
           reg9 == 0) %>%
    summarise(sum(cif))
  total_imp
  sum(monthly_sum_imp_new$sum_cif)
  # Warehousing
  total_wh <- icums_total_22 %>%
    filter(tradeflow == "Import",
           re == 0,
           warehouse == 1,
           reg9 == 0) %>%
    summarise(sum(cif))
  total_wh
  sum(monthly_sum_wh_new$sum_cif)
  # All fine! No further check necessary
  
  # Drop dataframes
  rm(import_icums_22_input, import_icums_22_clean, import_icums_22_month, import_icums_22_final,
     re_import_icums_22_input, re_import_icums_22_clean, re_import_icums_22_month, re_import_icums_22_final,
     wh_icums_22_input, wh_icums_22_clean, wh_icums_22_month, wh_icums_22_final,
     reg9_icums_22_input, reg9_icums_22_clean, reg9_icums_22_month, reg9_icums_22_final,
     export_icums_22_input, export_icums_22_clean, export_icums_22_month, export_icums_22_final,
     re_export_icums_22_input, re_export_icums_22_clean, re_export_icums_22_month, re_export_icums_22_final,
     monthly_sum_imp_new, monthly_sum_re_imp_new, monthly_sum_wh_new, monthly_sum_reg9_new,
     monthly_sum_exp_new, monthly_sum_re_exp_new)
}

# Using total data, now clean it and add columns to produce figures
{
  # Make data monthly - CHECK IF NECESSARY!!!
  month_icums_total_22 <- icums_total_22 %>%
    group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
    summarise(cif = sum(cif),
              fob = sum(fob),
              net_mass = sum(net_mass),
              gross_mass = sum(gross_mass))
  
  rm(icums_total_22)
  
  # Add label to HS codes --> gives us: month_icums_total_22_hs
  {
    hs_codes <- read_excel("data/HS_CODES.xlsx", col_names = FALSE)
    # Rename columns 
    colnames(hs_codes) <- c("hs_code", "hs_label")
    
    # Update HS codes dataframe
    hs_codes <- hs_codes %>% 
      mutate(hs2 = substr(hs_code, 1, 2),
             hs4 = ifelse(nchar(hs_code)>3, substr(hs_code, 1, 4), NA),
             hs10 = ifelse(nchar(hs_code)>9, substr(hs_code, 1, 10), NA)) %>%
      arrange(hs2, hs4, hs10) %>% 
      mutate(hs2_cat = ifelse(is.na(hs4) & !is.na(hs2), hs_label, NA),
             hs4_cat = ifelse(is.na(hs10) & !is.na(hs4), hs_label, NA),
             hs10_cat = ifelse(!is.na(hs10), hs_label, NA)) %>%
      fill(hs10_cat, .direction = "up") %>% 
      fill(hs4_cat, .direction = "up") %>% 
      fill(hs2_cat, .direction = "up") %>% 
      mutate(hs10_cat = ifelse(nchar(hs_code) < 10, NA, hs10_cat),
             hs4_cat = ifelse(nchar(hs_code) < 4, NA, hs4_cat),
             hs2_cat = ifelse(nchar(hs_code) < 2, NA, hs2_cat)) %>%
      select(!c(hs2, hs4, hs10, hs_label)) %>%
      mutate(hs2_cat =  paste0(toupper(substr(hs2_cat, 1, 1)), 
                               tolower(substr(hs2_cat, 2, nchar(hs2_cat)))),
             hs4_cat =  paste0(toupper(substr(hs4_cat, 1, 1)), 
                               tolower(substr(hs4_cat, 2, nchar(hs4_cat)))),
             hs10_cat =  paste0(toupper(substr(hs10_cat, 1, 1)), 
                                tolower(substr(hs10_cat, 2, nchar(hs10_cat))))) %>%
      filter(nchar(hs_code) == 10)
    
    # Seperately match on hs2
    hs_codes_2 <- hs_codes %>%
      mutate(hs2 = substr(hs_code, 1,2)) %>%
      select(hs2, hs2_cat) %>%
      group_by(hs2) %>%
      summarise(hs2_cat = unique(hs2_cat))
    
    # Match hs2 label to data
    month_icums_total_22_hs2 <- month_icums_total_22 %>%
      mutate(hs2 = substr(hs_code, 1, 2))
    month_icums_total_22_hs2 <- left_join(month_icums_total_22_hs2, hs_codes_2) 
    
    # Now match hs4 and hs10 codes as well
    hs_codes_rest <- hs_codes %>%
      select(-hs2_cat)
    month_icums_total_22_hs <- left_join(month_icums_total_22_hs2, hs_codes_rest) 
    
    # WARNING: THERE ARE 25 HS CODES WE CANNOT MATCH fully, all are matched on hs2 though
    sum(is.na(month_icums_total_22_hs$hs4_cat))
    test <- month_icums_total_22_hs[is.na(month_icums_total_22_hs$hs2_cat), ]
    
  }
  
  # Change country names from abbreviation to full names
  {
    # Read abbreviation country name matching file
    country <- read_excel("data/country_abbreviations.xlsx", col_names = TRUE) %>%
      # Add some extra abbreviations
      add_row(Country = c("Netherlands Antilles", "Unknown", "Serbia and Montenegro", "Midway Islands",
                          "Unknown", "Unknown", "East Timor", "Unknown"),
              Abbreviation = c("AN", "ZZ", "YU", "MI", 
                               "ZN", "OR", "TP", NA))
    
    month_icums_total_22_hs_country <- left_join(month_icums_total_22_hs, 
                                                 country, 
                                                 by = c("country_abb" = "Abbreviation")) %>%
      rename(country = Country)
    
    month_icums_total_22_hs_country <- month_icums_total_22_hs_country %>%
      mutate(country = case_when(reg9 == 1 ~ country_abb, 
                                 reg9 == 0 ~ country),
             country = ifelse(is.na(country), "Unknown", country)) 
    
    sum(is.na(month_icums_total_22_hs_country$country))
    unique(month_icums_total_22_hs_country$country)
    
    rm(country)
  }
  
  # Add continents - NOT YET DONE YET!!!
  {
    # Read continent matching to country file
    continent <- read.csv2("data/country_continent.csv")
    # Include all necessary countries to continent dataset
    continent <- rbind(continent, c("Antarctica", "Antarctica"), 
                       c("Netherlands Antilles", "South America"), 
                       c("Congo (the Democratic Republic of the)", "Africa"),
                       c("C?te D'Ivoire", "Africa"),
                       c("Korea", "Asia"),
                       c("Swaziland", "Africa"),
                       c("Unknown", "Unknown"),
                       c("British Indian Ocean Territory", "Asia"),
                       c("Christmas Island", "Asia"),
                       c("Lao People's Democratic Republic ","Asia"),
                       c("Yugoslavia", "Europe"),
                       c("Midway islands", "Oceania"),
                       c("Cocos (Keeling) Islands", "Asia"),
                       c("Brunei Darussalam","Asia"),
                       c("East Timor", "Asia"),
                       c("Holy See (the) [Vatican City State]", "Europe")) %>%
      filter(country != "South Korea", country != "North Korea",
             country != "Congo (the Democratic Republic of the)")
    
    # Merge continents to data
    month_icums_total_22_hs_country_cont <- stringdist_join(month_icums_total_22_hs_country, continent, 
                                                         by = "country", #match based on team
                                                         mode = 'left', #use left join
                                                         method = "jw", #use jw distance metric
                                                         max_dist = 0.3, 
                                                         distance_col ='dist') %>%
      group_by(country.x) %>%
      slice_min(order_by = dist, n = 1) %>% # Only select the best match
      ungroup() %>%
      select(!c(country.x, dist)) %>%
      rename(country = country.y)
  }
  
  icums_total_22_clean <- month_icums_total_22_hs_country %>%
    mutate(#year_quarter =  as.yearqtr(date, format = '%Y Q%q'),
           #quarter =  str_sub(year_quarter, start = -1),
           type = case_when(reg9 == 1 ~ "Regime 9",
                            re == 1 ~ paste0("Re-", tradeflow),
                            warehouse == 1 ~ "Warehouse",
                            TRUE ~ tradeflow))
  
  # rm(list=(ls()[ls()!="icums_total_22_clean"]))
}

# ALTERNATIVE = READ CLEAN MONTHLY DATA FROM WORKSPACE!
{
  load("total/input/icums_total_22_clean.RData")
  
}

### FIGURES ###

# Import and export per month
{
  # Create monthly dataset
  monthly_22 <- icums_total_22_clean %>%
    group_by(tradeflow, month, month_name, type) %>%
    summarise(cif = sum(cif),
              fob = sum(fob))
    
  # Import
  ggplot(filter(monthly_22, tradeflow == "Import"), 
                           aes(x = factor(month_name, levels = month.name), 
                               y = cif/10^9, 
                               fill = factor(type, levels =  c("Regime 9",
                                                               "Warehouse",
                                                               "Re-Import",
                                                               "Import")))) +
      geom_bar(stat = "identity") +
      blank_theme2 +
      labs(x = NULL, y = "Import (billion GHC)", fill = NULL)
  
  ggsave("total/output/import_monthly_22.png", height = 6, width = 9)
  
  # Export
  ggplot(filter(monthly_22, tradeflow == "Export"), 
         aes(x = factor(month_name, levels = month.name), 
             y = cif/10^9, 
             fill = factor(type, levels =  c("Re-Export", "Export")))) +
    geom_bar(stat = "identity") +
    blank_theme2 +
    labs(x = NULL, y = "Export (billion GHC)", fill = NULL)
  
  ggsave("total/output/export_monthly_22.png", height = 6, width = 9)
}

# Sunburst HS2 category
{
  # Split up in HS2 category
  cat_first_22 <- icums_total_22_clean %>%
    group_by(tradeflow, hs2_cat) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = hs2_cat) %>%
    rename(labels = hs2_cat) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  # Make sunburst import
  sunburst_hs2_imp_22 <- plot_ly(
    data = filter(cat_first_22, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif, 
    textposition = 'inside')
  
  # Save in 1100, 600 format
  sunburst_hs2_imp_22
  
  # Make sunburst import without regime 9
  # Split up in HS2 category
  cat_first_22_noreg9 <- icums_total_22_clean %>%
    filter(reg9 == 0) %>%
    group_by(tradeflow, hs2_cat) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = hs2_cat) %>%
    rename(labels = hs2_cat) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  sunburst_hs2_imp_22_noreg9 <- plot_ly(
    data = filter(cat_first_22_noreg9, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif, 
    textposition = 'inside')
  
  # Save in 1100, 600 format
  sunburst_hs2_imp_22_noreg9
  
  # Make sunburst export
  sunburst_hs2_exp_22 <- plot_ly(
    data = filter(cat_first_22, tradeflow == "Export"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_fob,
    parents= ~parents,
    ids = ~ids,
    text = ~share_fob, 
    textposition = 'inside')
  
  # Save in 1100, 600 format
  sunburst_hs2_exp_22
  
}

# Sunburst HS2 category + hs4 category
{
  # Split up in HS2 category first
  cat_hs4_22_step1 <- icums_total_22_clean %>%
    group_by(tradeflow, hs2_cat) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = hs2_cat) %>%
    rename(labels = hs2_cat) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  # Split up in hs2 and then country
  cat_hs4_22_step2 <- icums_total_22_clean %>%
    group_by(tradeflow, hs2_cat, hs4_cat) %>%
    mutate(parents = hs2_cat) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob),
              parents = parents[1],
              ids = paste(parents[1], "-", hs4_cat[1])) %>%
    rename(labels = hs4_cat) %>%
    ungroup() %>%
    group_by(parents, tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = "")) %>%
    ungroup() %>%
    select(-hs4_cat)
  
  
  # Combine for sunburst
  cat_hs4_22 <- do.call("rbind",
                            list(cat_hs4_22_step1, cat_hs4_22_step2))
  
  
  rm(cat_hs4_22_step1, cat_hs4_22_step2)
  
  # Create import sunburst
  sunburst_cat_hs4_imp_22 <- plot_ly(
    data = filter(cat_hs4_22, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif, 
    textposition = 'inside')
  
  # Save in 1100, 600 format
  sunburst_cat_hs4_imp_22
  
  # Drop regime 9
  {
    # Split up in HS2 category first
    cat_hs4_22_step1 <- icums_total_22_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, hs2_cat) %>%
      summarise(values_cif = sum(cif),
                values_fob = sum(fob)) %>%
      mutate(parents = "",
             ids = hs2_cat) %>%
      rename(labels = hs2_cat) %>%
      group_by(tradeflow) %>%
      mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
             share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
      ungroup() 
    
    # Split up in hs2 and then country
    cat_hs4_22_step2 <- icums_total_22_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, hs2_cat, hs4_cat) %>%
      mutate(parents = hs2_cat) %>%
      summarise(values_cif = sum(cif),
                values_fob = sum(fob),
                parents = parents[1],
                ids = paste(parents[1], "-", hs4_cat[1])) %>%
      rename(labels = country) %>%
      ungroup() %>%
      group_by(parents, tradeflow) %>%
      mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
             share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = "")) %>%
      ungroup() %>%
      select(-hs4_cat)
    
    
    # Combine for sunburst
    cat_hs4_22_noreg9 <- do.call("rbind",
                                     list(cat_hs4_22_step1, cat_hs4_22_step2))
    
    
    rm(cat_hs4_22_step1, cat_hs4_22_step2)
    
    # Create import sunburst
    sunburst_cat_hs4_22_noreg9 <- plot_ly(
      data = filter(cat_hs4_22_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif, 
      textposition = 'inside')
    
    # Save in 1100, 600 format
    sunburst_cat_hs4_22_noreg9
    
  }
  
  # Make sunburst export
  sunburst_cat_hs4_exp_22 <- plot_ly(
    data = filter(cat_hs4_22, tradeflow == "Export"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_fob,
    parents= ~parents,
    ids = ~ids,
    text = ~share_fob, 
    textposition = 'inside')
  
  # Save in 1100, 600 format
  sunburst_cat_hs4_exp_22
  
}

# Sunburst HS2 + country
{
  # Split up in HS2 category first
  cat_country_22_step1 <- icums_total_22_clean %>%
    group_by(tradeflow, hs2_cat) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = hs2_cat) %>%
    rename(labels = hs2_cat) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  # Split up in hs2 and then country
  cat_country_22_step2 <- icums_total_22_clean %>%
    group_by(tradeflow, hs2_cat, country) %>%
    mutate(parents = hs2_cat) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob),
              parents = parents[1],
              ids = paste(parents[1], "-", country[1])) %>%
    rename(labels = country) %>%
    ungroup() %>%
    group_by(parents, tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = "")) %>%
    ungroup() %>%
    select(-hs2_cat)
  
  
  # Combine for sunburst
  cat_country_22 <- do.call("rbind",
                           list(cat_country_22_step1, cat_country_22_step2))
  
  
  rm(cat_country_22_step1, cat_country_22_step2)
  
  # Create import sunburst
  sunburst_cat_country_imp_22 <- plot_ly(
    data = filter(cat_country_22, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif, 
    textposition = 'inside')
  
  # Save in 1100, 600 format
  sunburst_cat_country_imp_22
  
  # Drop regime 9
  {
    # Split up in HS2 category first
    cat_country_22_step1 <- icums_total_22_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, hs2_cat) %>%
      summarise(values_cif = sum(cif),
                values_fob = sum(fob)) %>%
      mutate(parents = "",
             ids = hs2_cat) %>%
      rename(labels = hs2_cat) %>%
      group_by(tradeflow) %>%
      mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
             share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
      ungroup() 
    
    # Split up in hs2 and then country
    cat_country_22_step2 <- icums_total_22_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, hs2_cat, country) %>%
      mutate(parents = hs2_cat) %>%
      summarise(values_cif = sum(cif),
                values_fob = sum(fob),
                parents = parents[1],
                ids = paste(parents[1], "-", country[1])) %>%
      rename(labels = country) %>%
      ungroup() %>%
      group_by(parents, tradeflow) %>%
      mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
             share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = "")) %>%
      ungroup() %>%
      select(-hs2_cat)
    
    
    # Combine for sunburst
    cat_country_22_noreg9 <- do.call("rbind",
                              list(cat_country_22_step1, cat_country_22_step2))
    
    
    rm(cat_country_22_step1, cat_country_22_step2)
    
    # Create import sunburst
    sunburst_cat_country_22_noreg9 <- plot_ly(
      data = filter(cat_country_22_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif, 
      textposition = 'inside')
    
    # Save in 1100, 600 format
    sunburst_cat_country_22_noreg9
    
  }
  
  # Make sunburst export
  sunburst_cat_country_exp_22 <- plot_ly(
    data = filter(cat_country_22, tradeflow == "Export"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_fob,
    parents= ~parents,
    ids = ~ids,
    text = ~share_fob, 
    textposition = 'inside')
  
  # Save in 1100, 600 format
  sunburst_cat_country_exp_22
  
}

# Sunburst country
{
  # Split up in country
  country_first_22 <- icums_total_22_clean %>%
    group_by(tradeflow, country) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = country) %>%
    rename(labels = country) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  # Make sunburst import
  sunburst_country_imp_22 <- plot_ly(
    data = filter(country_first_22, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif, 
    textposition = 'inside')
  
  # Save in 1100, 600 format
  sunburst_country_imp_22
  
  # Make sunburst import without regime 9
  # Split up in country
  country_first_22_noreg9 <- icums_total_22_clean %>%
    filter(reg9 == 0) %>%
    group_by(tradeflow, country) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = country) %>%
    rename(labels = country) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  sunburst_country_imp_22_noreg9 <- plot_ly(
    data = filter(country_first_22_noreg9, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif, 
    textposition = 'inside')
  
  # Save in 1100, 600 format
  sunburst_country_imp_22_noreg9
  
  # Make sunburst export
  sunburst_country_exp_22 <- plot_ly(
    data = filter(country_first_22, tradeflow == "Export"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_fob,
    parents= ~parents,
    ids = ~ids,
    text = ~share_fob, 
    textposition = 'inside')
  
  # Save in 1100, 600 format
  sunburst_country_exp_22
  
  
}

# Sunburst country + HS2
{
  # Split up in country first
  country_cat_22_step1 <- icums_total_22_clean %>%
    group_by(tradeflow, country) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = country) %>%
    rename(labels = country) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  # Split up in country then hs2
  country_cat_22_step2 <- icums_total_22_clean %>%
    group_by(tradeflow, country, hs2_cat) %>%
    mutate(parents = country) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob),
              parents = parents[1],
              ids = paste(parents[1], "-", hs2_cat[1])) %>%
    rename(labels = hs2_cat) %>%
    ungroup() %>%
    group_by(parents, tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = "")) %>%
    ungroup() %>%
    select(-country)
  
  
  # Combine for sunburst
  country_cat_22 <- do.call("rbind",
                            list(country_cat_22_step1, country_cat_22_step2))
  
  
  rm(country_cat_22_step1, country_cat_22_step2)
  
  # Create import sunburst
  sunburst_country_cat_imp_22 <- plot_ly(
    data = filter(country_cat_22, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif, 
    textposition = 'inside')
  
  # Save in 1100, 600 format
  sunburst_country_cat_imp_22
  
  # Drop regime 9
  {
    # Split up in country first
    country_cat_22_step1 <- icums_total_22_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, country) %>%
      summarise(values_cif = sum(cif),
                values_fob = sum(fob)) %>%
      mutate(parents = "",
             ids = country) %>%
      rename(labels = country) %>%
      group_by(tradeflow) %>%
      mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
             share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
      ungroup() 
    
    # Split up in hs2 and then country
    country_cat_22_step2 <- icums_total_22_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, country, hs2_cat) %>%
      mutate(parents = country) %>%
      summarise(values_cif = sum(cif),
                values_fob = sum(fob),
                parents = parents[1],
                ids = paste(parents[1], "-", hs2_cat[1])) %>%
      rename(labels = hs2_cat) %>%
      ungroup() %>%
      group_by(parents, tradeflow) %>%
      mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
             share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = "")) %>%
      ungroup() %>%
      select(-country)
    
    
    # Combine for sunburst
    country_cat_22_noreg9 <- do.call("rbind",
                                     list(country_cat_22_step1, country_cat_22_step2))
    
    
    rm(country_cat_22_step1, country_cat_22_step2)
    
    # Create import sunburst no reg9
    sunburst_country_cat_22_noreg9 <- plot_ly(
      data = filter(country_cat_22_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif, 
      textposition = 'inside')
    
    # Save in 1100, 600 format
    sunburst_country_cat_22_noreg9
    
  }
  
  # Make sunburst export
  sunburst_country_cat_exp_22 <- plot_ly(
    data = filter(country_cat_22, tradeflow == "Export"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_fob,
    parents= ~parents,
    ids = ~ids,
    text = ~share_fob, 
    textposition = 'inside')
  
  # Save in 1100, 600 format
  sunburst_country_cat_exp_22
  
}


# Data request: 2022
{
  # Make data monthly
  month_icums_total_22 <- icums_total_22 %>%
    group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
    summarise(cif = sum(cif),
              fob = sum(fob),
              net_mass = sum(net_mass),
              gross_mass = sum(gross_mass))
  
  rm(icums_total_22)
  
  # Add label to HS codes
  {
    hs_codes <- read_excel("data/HS_CODES.xlsx", col_names = FALSE)
    # Rename columns 
    colnames(hs_codes) <- c("hs_code", "hs_label")
    
    # Update HS codes dataframe
    hs_codes <- hs_codes %>% 
      mutate(hs2 = substr(hs_code, 1, 2),
             hs4 = ifelse(nchar(hs_code)>3, substr(hs_code, 1, 4), NA),
             hs10 = ifelse(nchar(hs_code)>9, substr(hs_code, 1, 10), NA)) %>%
      arrange(hs2, hs4, hs10) %>% 
      mutate(hs2_cat = ifelse(is.na(hs4) & !is.na(hs2), hs_label, NA),
             hs4_cat = ifelse(is.na(hs10) & !is.na(hs4), hs_label, NA),
             hs10_cat = ifelse(!is.na(hs10), hs_label, NA)) %>%
      fill(hs10_cat, .direction = "up") %>% 
      fill(hs4_cat, .direction = "up") %>% 
      fill(hs2_cat, .direction = "up") %>% 
      mutate(hs10_cat = ifelse(nchar(hs_code) < 10, NA, hs10_cat),
             hs4_cat = ifelse(nchar(hs_code) < 4, NA, hs4_cat),
             hs2_cat = ifelse(nchar(hs_code) < 2, NA, hs2_cat)) %>%
      select(!c(hs2, hs4, hs10, hs_label)) %>%
      mutate(hs2_cat =  paste0(toupper(substr(hs2_cat, 1, 1)), 
                               tolower(substr(hs2_cat, 2, nchar(hs2_cat)))),
             hs4_cat =  paste0(toupper(substr(hs4_cat, 1, 1)), 
                               tolower(substr(hs4_cat, 2, nchar(hs4_cat)))),
             hs10_cat =  paste0(toupper(substr(hs10_cat, 1, 1)), 
                                tolower(substr(hs10_cat, 2, nchar(hs10_cat))))) %>%
      filter(nchar(hs_code) == 10)
    
    # Seperately match on hs2
    hs_codes_2 <- hs_codes %>%
      mutate(hs2 = substr(hs_code, 1,2)) %>%
      select(hs2, hs2_cat) %>%
      group_by(hs2) %>%
      summarise(hs2_cat = unique(hs2_cat))
    
    # Match hs2 label to data
    month_icums_total_22_hs2 <- month_icums_total_22 %>%
      mutate(hs2 = substr(hs_code, 1, 2))
    month_icums_total_22_hs2 <- left_join(month_icums_total_22_hs2, hs_codes_2) 
    
    # Now match hs4 and hs10 codes as well
    hs_codes_rest <- hs_codes %>%
      select(-hs2_cat)
    month_icums_total_22_hs <- left_join(month_icums_total_22_hs2, hs_codes_rest) 
    
    # WARNING: THERE ARE 25 HS CODES WE CANNOT MATCH fully, all are matched on hs2 though
    sum(is.na(month_icums_total_22_hs$hs4_cat))
    test <- month_icums_total_22_hs[is.na(month_icums_total_22_hs$hs2_cat), ]

  }
  
  
  # Yearly: to select top hs codes
  {
    hs10_data_req_year <- month_icums_total_22_hs %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, year, hs10_cat, hs4_cat, hs2_cat, hs_code) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
    hs4_data_req_year <- month_icums_total_22_hs %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, year, hs4_cat, hs2_cat) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
    hs2_data_req_year <- month_icums_total_22_hs %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, year, hs2_cat) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  
  # Monthly = FINAL EXTRACTION
  # Create monthly export and import totals based on hs10 code
  data_req <- month_icums_total_22_hs %>%
    ungroup() %>%
    filter(reg9 == 0, # No regime 9
           hs_code != "4907000000") %>% # Drop banknotes from data
    group_by(tradeflow, year, month, month_name, hs10_cat, hs4_cat, hs2_cat, hs_code) %>%
    summarise(value_exp = sum(fob),
              value_imp = sum(cif))
  
  # Select top 10 categories first
  {
    # First create yearly totals per hs10
    hs10_data_req_year <- data_req %>%
      group_by(tradeflow, year, hs10_cat, hs4_cat, hs2_cat, hs_code) %>%
      summarise(value_exp = sum(value_exp),
                value_imp = sum(value_imp))
    
    # Export
    top10_export_hs10 <- hs10_data_req_year %>%
      filter(tradeflow == "Export") %>%
      arrange(-value_exp) %>%
      head(10) %>%
      pull(hs_code)
    
    # Import
    top10_import_hs10 <- hs10_data_req_year %>%
      filter(tradeflow == "Import") %>%
      arrange(-value_imp) %>%
      head(10) %>%
      pull(hs_code)
    }
  
  # Export
  {
    # Separate the top 10
    export_top10 <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Export",
             hs_code %in% top10_export_hs10) %>%
      select(-month, -value_imp) %>%
      pivot_wider(names_from = month_name, values_from = value_exp) %>%
      mutate(yearly_total = rowSums(across(January:December), na.rm = T)) %>%
      arrange(-yearly_total)
    
    # Add the other items
    export_others <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Export",
             !(hs_code %in% top10_export_hs10)) %>%
      group_by(year, tradeflow, month, month_name) %>%
      summarise(value_exp = sum(value_exp)) %>%
      ungroup() %>%
      select(-month) %>%
      pivot_wider(names_from = month_name, values_from = value_exp) %>%
      mutate(yearly_total = rowSums(across(January:December), na.rm = T),
             hs10_cat = "Others", hs4_cat = "", hs2_cat = "", hs_code = "")
    
    # Add the total
    export_totals <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Export") %>%
      group_by(year, tradeflow, month, month_name) %>%
      summarise(value_exp = sum(value_exp)) %>%
      ungroup() %>%
      select(-month) %>%
      pivot_wider(names_from = month_name, values_from = value_exp)  %>%
      mutate(yearly_total = rowSums(across(January:December), na.rm = T),
             hs10_cat = "Total", hs4_cat = "", hs2_cat = "", hs_code = "")
    
    # Merge
    export_table <- rbind(export_top10, export_others, export_totals)
    }
  
  # Import
  {
    # Seperate the top 10
    import_top10 <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Import",
             hs_code %in% top10_import_hs10) %>%
      select(-month, -value_exp) %>%
      pivot_wider(names_from = month_name, values_from = value_imp) %>%
      mutate(yearly_total = rowSums(across(January:December), na.rm = T)) %>%
      arrange(-yearly_total)
    
    # Add the other items
    import_others <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Import",
             !(hs_code %in% top10_import_hs10)) %>%
      group_by(year, tradeflow, month, month_name) %>%
      summarise(value_imp = sum(value_imp)) %>%
      ungroup() %>%
      select(-month) %>%
      pivot_wider(names_from = month_name, values_from = value_imp) %>%
      mutate(yearly_total = rowSums(across(January:December), na.rm = T),
             hs10_cat = "Others", hs4_cat = "", hs2_cat = "", hs_code = "")
    
    # Add the total
    import_totals <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Import") %>%
      group_by(year, tradeflow, month, month_name) %>%
      summarise(value_imp = sum(value_imp)) %>%
      ungroup() %>%
      select(-month) %>%
      pivot_wider(names_from = month_name, values_from = value_imp) %>%
      mutate(yearly_total = rowSums(across(January:December), na.rm = T),
             hs10_cat = "Total", hs4_cat = "", hs2_cat = "", hs_code = "")
    
    # Merge
    import_table <- rbind(import_top10, import_others, import_totals)
  }
  
  # Save into Excel
  # Create workbook
  wb_request <- createWorkbook()
  # Add sheet
  addWorksheet(wb_request, "Trade_data") 
  
  # Add dataframe Export
  writeData(wb_request, sheet = "Trade_data", export_table,
            startCol = 1, startRow = 1,rowNames = FALSE)
  
  # Add dataframe Import
  writeData(wb_request, sheet = "Trade_data", import_table,
            startCol = 1, startRow = 15,rowNames = FALSE)
  
  # Save workbook to excel
  saveWorkbook(wb_request, "total/output/trade_export_import_request_2023_01_13.xlsx", overwrite = TRUE)
  
  

}




###################################
############## 2021 ###############
###################################

# Read 2021 Icums data - OR LOAD DATA DIRECTLY FROM R WORKSPACE!!!
{
  # Path for all data files 
  pathname_icums_21 <- "data/raw_data/ICUMS DATA 2021"
  # File list of all files in 2022 data
  icums_file_list_21 <- list.files(pathname_icums_21)
  
  ### Read Import ###
  # Create file list
  icums_import_file_list_21 <- icums_file_list_21[grepl("Merchandised Import", icums_file_list_21)]
  # Make list of all excel sheets
  import_icums_21 <- lapply(icums_import_file_list_21, function(x) { # This function loops over all files
    sheets <- readxl::excel_sheets(paste(pathname_icums_21, x, sep = "/")) # Per file it gives us a list of sheet names
    lapply(sheets, function(y) { # This function then loops over all sheets
      readxl::read_excel(paste(pathname_icums_21, x, sep = "/"), 
                         sheet = y, 
                         col_names = TRUE, skip = 4)
    })
  })
  
  # Now make into dataframe, by unlisting and binding rows
  import_icums_21_list <- unlist(import_icums_21, recursive = FALSE)
  import_icums_21_input <- do.call("bind_rows", import_icums_21_list)
  
  ### Read Re-Import ###
  # Create file list
  icums_re_import_file_list_21 <- icums_file_list_21[grepl("Merchandised Re-Import", icums_file_list_21)]
  # Make list of all excel sheets
  re_import_icums_21 <- lapply(icums_re_import_file_list_21, function(x) { # This function loops over all files
    sheets <- readxl::excel_sheets(paste(pathname_icums_21, x, sep = "/")) # Per file it gives us a list of sheet names
    lapply(sheets, function(y) { # This function then loops over all sheets
      readxl::read_excel(paste(pathname_icums_21, x, sep = "/"),
                         sheet = y, 
                         col_names = TRUE, skip = 4)
    })
  })
  
  # Now make into dataframe, by unlisting and binding rows
  re_import_icums_21_list <- unlist(re_import_icums_21, recursive = FALSE)
  re_import_icums_21_input <- do.call("bind_rows", re_import_icums_21_list)
  
  ### Read Warehousing ###
  # Create file list
  icums_wh_file_list_21 <- icums_file_list_21[grepl("Warehousing", icums_file_list_21)]
  # Make list of all excel sheets
  wh_icums_21 <- lapply(icums_wh_file_list_21, function(x) { # This function loops over all files
    sheets <- readxl::excel_sheets(paste(pathname_icums_21, x, sep = "/")) # Per file it gives us a list of sheet names
    lapply(sheets, function(y) { # This function then loops over all sheets
      readxl::read_excel(paste(pathname_icums_21, x, sep = "/"), 
                         sheet = y, 
                         col_names = TRUE, skip = 4)
    })
  })
  
  # Now make into dataframe, by unlisting and binding rows
  wh_icums_21_list <- unlist(wh_icums_21, recursive = FALSE)
  wh_icums_21_input <- do.call("bind_rows", wh_icums_21_list)
  
  
  ### Read Regime 9 ###
  # Pathname reg 9
  pathname_icums_reg9 <- "data/raw_data/REGIME 9"
  # File list of all files of regime 9
  icums_reg9_file_list <- list.files(pathname_icums_reg9)
  # Create file list
  icums_reg9_file_list_21 <- icums_reg9_file_list[grepl("2021", icums_reg9_file_list)]
  # Make list of all excel sheets
  reg9_icums_21 <- lapply(icums_reg9_file_list_21, function(x) { # This function loops over all files
    sheets <- readxl::excel_sheets(paste(pathname_icums_reg9, x, sep = "/")) # Per file it gives us a list of sheet names
    lapply(sheets, function(y) { # This function then loops over all sheets
      readxl::read_excel(paste(pathname_icums_reg9, x, sep = "/"), 
                         sheet = y, 
                         col_names = TRUE, skip = 5)
    })
  })
  
  # Now make into dataframe, by unlisting and binding rows
  reg9_icums_21_list <- unlist(reg9_icums_21, recursive = FALSE)
  reg9_icums_21_input <- do.call("bind_rows", reg9_icums_21_list)
  
  
  ### Read Export ###
  # Create file list
  icums_export_file_list_21 <- icums_file_list_21[grepl("Merchandised Export", icums_file_list_21)]
  # Make list of all excel sheets
  export_icums_21 <- lapply(icums_export_file_list_21, function(x) { # This function loops over all files
    sheets <- readxl::excel_sheets(paste(pathname_icums_21, x, sep = "/")) # Per file it gives us a list of sheet names
    lapply(sheets, function(y) { # This function then loops over all sheets
      readxl::read_excel(paste(pathname_icums_21, x, sep = "/"), 
                         sheet = y, 
                         col_names = TRUE, skip = 4)
    })
  })
  
  # Now make into dataframe, by unlisting and binding rows
  export_icums_21_list <- unlist(export_icums_21, recursive = FALSE)
  export_icums_21_input <- do.call("bind_rows", export_icums_21_list)
  
  ### Read Re-Export ###
  # Create file list
  icums_re_export_file_list_21 <- icums_file_list_21[grepl("Merchandised Re-Export", icums_file_list_21)]
  # Make list of all excel sheets
  re_export_icums_21 <- lapply(icums_re_export_file_list_21, function(x) { # This function loops over all files
    sheets <- readxl::excel_sheets(paste(pathname_icums_21, x, sep = "/")) # Per file it gives us a list of sheet names
    lapply(sheets, function(y) { # This function then loops over all sheets
      readxl::read_excel(paste(pathname_icums_21, x, sep = "/"), 
                         sheet = y, 
                         col_names = TRUE, skip = 4)
    })
  })
  
  # Now make into dataframe, by unlisting and binding rows
  re_export_icums_21_list <- unlist(re_export_icums_21, recursive = FALSE)
  re_export_icums_21_input <- do.call("bind_rows", re_export_icums_21_list)
  
  ### Drop dataframes ###
  rm(pathname_icums_21, icums_file_list_21,
     icums_import_file_list_21, import_icums_21, import_icums_21_list,
     icums_re_import_file_list_21, re_import_icums_21, re_import_icums_21_list,
     icums_wh_file_list_21, wh_icums_21, wh_icums_21_list,
     pathname_icums_reg9, icums_reg9_file_list, icums_reg9_file_list_21, reg9_icums_21, reg9_icums_21_list,
     icums_export_file_list_21, export_icums_21, export_icums_21_list,
     icums_re_export_file_list_21, re_export_icums_21, re_export_icums_21_list)

}

# ALTERNATIVE = READ RAW FROM WORKSPACE!
{
  load("total/input/raw_icums_21.RData")
}

# Rename columns and select, same format for every type of input
{
  # Clean Import
  import_icums_21_clean <- import_icums_21_input %>%
    mutate(date = convert_to_date(HEAD_TIME_PROC, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 0,
           re = 0,
           reg9 = 0,
           tradeflow = "Import") %>%
    rename(hs_code = ITEMS_HS_CODE,
           country_abb = HEAD_COUNTRY_ORIG_DEST,
           country_cons = COUNTRY_OF_CONSIGNMENT,
           cif = ITEMS_CIF_GHC,
           fob = ITEMS_FOB_GHC,
           net_mass = ITEMS_NET_MASS,
           gross_mass = ITEMS_GROSS_MASS,
           desc = ITEMS_GOODS_DESC,
           head_cust_off = HEAD_CUST_OFF_CODE,
           head_decl_no = HEAD_DECL_NO,
           head_declarant_id = HEAD_DECLARANT_ID,
           head_declarant_name = HEAD_DECLARANT_NAME,
           head_porter_code = HEAD_IMPORTER_CODE,
           head_porter_name = HEAD_IMPORTER_NAME) %>%
    select(tradeflow, date, year, month, month_name, day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re, reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Clean Re-Import
  re_import_icums_21_clean <- re_import_icums_21_input %>%
    mutate(date = convert_to_date(HEAD_TIME_PROC, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 0,
           re = 1,
           reg9 = 0,
           tradeflow = "Import") %>%
    rename(hs_code = ITEMS_HS_CODE,
           country_abb = HEAD_COUNTRY_ORIG_DEST,
           country_cons = COUNTRY_OF_CONSIGNMENT,
           cif = ITEMS_CIF_GHC,
           fob = ITEMS_FOB_GHC,
           net_mass = ITEMS_NET_MASS,
           gross_mass = ITEMS_GROSS_MASS,
           desc = ITEMS_GOODS_DESC,
           head_cust_off = HEAD_CUST_OFF_CODE,
           head_decl_no = HEAD_DECL_NO,
           head_declarant_id = HEAD_DECLARANT_ID,
           head_declarant_name = HEAD_DECLARANT_NAME,
           head_porter_code = HEAD_IMPORTER_CODE,
           head_porter_name = HEAD_IMPORTER_NAME) %>%
    select(tradeflow, date, year, month, month_name, day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re, reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Clean Warehousing
  wh_icums_21_clean <- wh_icums_21_input %>%
    mutate(date = convert_to_date(BOE_ISSUE_DATE, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 1,
           re = 0,
           reg9 = 0,
           head_cust_off = NA,
           head_porter_code = NA,
           country_cons = COUNTRY_OF_SHIPMENT, # As no country of consignment, add it as country of shipment
           tradeflow = "Import") %>% 
    rename(hs_code = ITEMS_HS_CODE,
           country_abb = COUNTRY_OF_SHIPMENT,
           cif = ITEMS_CIF_GHC,
           fob = ITEMS_FOB_GHC,
           net_mass = ITEMS_NET_MASS,
           gross_mass = ITEMS_GROSS_MASS,
           desc = ITEMS_GOODS_DESC,
           head_declarant_id = HEAD_DECLARANT_ID,
           head_declarant_name = HEAD_DECLARANT_NAME,
           head_porter_name = HEAD_IMPORTER_NAME,
           head_decl_no = BOE_NUMBER) %>%
    select(tradeflow, date, year, month, month_name, day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re, reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Clean Regime 9
  reg9_icums_21_clean <- reg9_icums_21_input %>%
    mutate(date = convert_to_date(BOE_DECLARATION_DATE, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 0,
           re = 0,
           reg9 = 1,
           tradeflow = "Import",
           head_declarant_id = NA, # NOT IN DATA
           head_declarant_name = NA, # NOT IN DATA
           net_mass = NA # NOT IN DATA
    ) %>%
    rename(hs_code = ITEM_HS_CODE, # ITEM INSTEAD OF ITEMS
           country_abb = COUNTRY_OF_ORIGIN, #DIFF, FULL NAMES
           country_cons = COUNTRY_OF_CONSIGNMENT, # DIFF FULL NAMES
           cif = ITEM_CIF_GHS, # ITEM NOT S AND GHS NOT GHC
           fob = ITEM_FOB_GHS, # ITEM NOT S AND GHS NOT GHC
           gross_mass = ITEM_GROSS_WEIGHT_KG, # DIFF
           desc = ITEM_GOODS_DESCRIPTION, # DESCRIPTION INSTEAD OF DESC
           head_cust_off = CUSTOMS_CLEARANCE_OFFICE, # INSTEAD OF HEAD_CUST_OFF_CODE
           head_porter_code = IMPORTER_TIN, # MAYBE IMPORTER_TIN?
           head_porter_name = IMPORTER_NAME, # NO HEAD
           head_decl_no = BOE_NO) %>% 
    select(tradeflow, date, year, month, month_name, day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re, reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Clean Export
  export_icums_21_clean <- export_icums_21_input %>%
    mutate(date = convert_to_date(HEAD_TIME_PROC, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 0,
           re = 0,
           reg9 = 0,
           tradeflow = "Export") %>%
    rename(hs_code = ITEMS_HS_CODE,
           country_abb = HEAD_COUNTRY_ORIG_DEST,
           country_cons = COUNTRY_OF_CONSIGNMENT,
           cif = ITEMS_CIF_GHC,
           fob = ITEMS_FOB_GHC,
           net_mass = ITEMS_NET_MASS,
           gross_mass = ITEMS_GROSS_MASS,
           desc = ITEMS_GOODS_DESC,
           head_cust_off = HEAD_CUST_OFF_CODE,
           head_decl_no = HEAD_DECL_NO,
           head_declarant_id = HEAD_DECLARANT_ID,
           head_declarant_name = HEAD_DECLARANT_NAME,
           head_porter_code = HEAD_EXPORTER_CODE,
           head_porter_name = HEAD_EXPORTER_NAME) %>%
    select(tradeflow, date, year, month, month_name, day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re, reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Clean Re-Export
  re_export_icums_21_clean <- re_export_icums_21_input %>%
    mutate(date = convert_to_date(HEAD_TIME_PROC, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 0,
           re = 1,
           reg9 = 0,
           tradeflow = "Export") %>%
    rename(hs_code = ITEMS_HS_CODE,
           country_abb = HEAD_COUNTRY_ORIG_DEST,
           country_cons = COUNTRY_OF_CONSIGNMENT,
           cif = ITEMS_CIF_GHC,
           fob = ITEMS_FOB_GHC,
           net_mass = ITEMS_NET_MASS,
           gross_mass = ITEMS_GROSS_MASS,
           desc = ITEMS_GOODS_DESC,
           head_cust_off = HEAD_CUST_OFF_CODE,
           head_decl_no = HEAD_DECL_NO,
           head_declarant_id = HEAD_DECLARANT_ID,
           head_declarant_name = HEAD_DECLARANT_NAME,
           head_porter_code = HEAD_EXPORTER_CODE,
           head_porter_name = HEAD_EXPORTER_NAME) %>%
    select(tradeflow, date, year, month, month_name,day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re,reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Drop raw dataframes
  rm(import_icums_21_input, re_import_icums_21_input, wh_icums_21_input,
     reg9_icums_21_input, export_icums_21_input, re_export_icums_21_input)
}

# ALTERNATIVE = READ RAW FROM WORKSPACE!
{
  load("total/input/raw_icums_21_clean.RData")
}

# First sanity checks
{
  ### Import checks ###
  {
    # Yearly totals
    yearly_sum_imp <- import_icums_21_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif, na.rm = TRUE)/10^6,
                max_cif = max(cif, na.rm = TRUE)/10^6,
                sum_cif = sum(cif, na.rm = TRUE)/10^9,
                min_fob = min(fob, na.rm = TRUE)/10^6,
                max_fob = max(fob, na.rm = TRUE)/10^6,
                sum_fob = sum(fob, na.rm = TRUE)/10^9,
                sum_na_cif = sum(is.na(cif)))
    yearly_sum_imp
    
    # NA value cif!!!
    na_imp_cif_21 <- import_icums_21_clean %>%
      filter(is.na(cif))
    na_imp_cif_21
    
    # Summary statistics per month
    monthly_sum_imp <- import_icums_21_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif, na.rm = TRUE)/10^6,
                max_cif = max(cif, na.rm = TRUE)/10^6,
                sum_cif = sum(cif, na.rm = TRUE)/10^6,
                min_fob = min(fob, na.rm = TRUE)/10^6,
                max_fob = max(fob, na.rm = TRUE)/10^6,
                sum_fob = sum(fob, na.rm = TRUE)/10^6,
                sum_na_cif = sum(is.na(cif)))
    monthly_sum_imp
    
    # Overview in table with top 50 cif each month
    top10_cif_month_import <- import_icums_21_clean %>%
      group_by(month) %>%
      arrange(-cif) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:10) %>%
      ungroup() %>%
      arrange(-cif)
    
    # Overview of 0 values CIF 
    cif_0_import <- import_icums_21_clean %>%
      filter(cif == 0) 
    
    # Make plot
    imp_top10_plot <-  ggplot(top10_cif_month_import,
                              aes(x = factor(month_name, levels = month.name), 
                                  y = cif, 
                                  fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Import, cif (in GHC)", fill = "Rank",
           title = "Monthly maximum single imports in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    imp_top10_plot
    
  }
  
  ### Re-Import checks ###
  {
    # Yearly totals
    yearly_sum_re_imp <- re_import_icums_21_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_re_imp
    
    # Summary statistics per month
    monthly_sum_re_imp <- re_import_icums_21_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_re_imp
    
    # Overview in table with top 50 cif each month
    top10_cif_month_re_import <- re_import_icums_21_clean %>%
      group_by(month) %>%
      arrange(-cif) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:length(cif)) %>% # length(cif) as not 50 for every month
      ungroup() %>%
      arrange(-cif)
    
    # Overview of 0 values CIF 
    cif_0_re_import <- re_import_icums_21_clean %>%
      filter(cif == 0) 
    
    # Make plot
    re_imp_top10_plot <- ggplot(top10_cif_month_re_import,
                                aes(x = factor(month_name, levels = month.name), 
                                    y = cif, 
                                    fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Re-Import, cif (in GHC)", fill = "Rank",
           title = "Monthly maximum single re-imports in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    re_imp_top10_plot
  }
  
  ### Warehousing checks ###
  {
    # Yearly totals
    yearly_sum_wh <- wh_icums_21_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_wh
    
    # Summary statistics per month
    monthly_sum_wh <- wh_icums_21_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_wh
    
    # Overview in table with top 50 cif each month
    top10_cif_month_wh <- wh_icums_21_clean %>%
      group_by(month) %>%
      arrange(-cif) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:10) %>%
      ungroup() %>%
      arrange(-cif)
    
    # Overview of 0 values CIF 
    cif_0_wh <- wh_icums_21_clean %>%
      filter(cif == 0) 
    
    # Make plot
    wh_top10_plot <- ggplot(top10_cif_month_wh,
                            aes(x = factor(month_name, levels = month.name), 
                                y = cif, 
                                fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Warehousing, cif (in GHC)", fill = "Rank",
           title = "Monthly maximum single warehousing in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    wh_top10_plot
  }
  
  ### Regime 9 checks ###
  {
    # Yearly totals
    yearly_sum_reg9 <- reg9_icums_21_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_reg9
    
    # Negative value cif!!!
    neg_reg9_21 <- reg9_icums_21_clean %>%
      filter(cif < 0)
    neg_reg9_21
    
    # Summary statistics per month
    monthly_sum_reg9 <- reg9_icums_21_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_reg9
    
    # Overview in table with top 50 cif each month
    top10_cif_month_reg9 <- reg9_icums_21_clean %>%
      group_by(month) %>%
      arrange(-cif) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:10) %>%
      ungroup() %>%
      arrange(-cif)
    
    # Overview of 0 values CIF 
    cif_0_reg9 <- reg9_icums_21_clean %>%
      filter(cif == 0) 
    
    # Make plot
    reg9_top10_plot <-  ggplot(top10_cif_month_reg9,
                               aes(x = factor(month_name, levels = month.name), 
                                   y = cif, 
                                   fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Regime 9, cif (in GHC)", fill = "Rank",
           title = "Monthly maximum single regime 9 in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    reg9_top10_plot
    
  }
  
  ### Export checks ###
  {
    # Yearly totals
    yearly_sum_exp <- export_icums_21_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_exp
    
    # Summary statistics per month
    monthly_sum_exp <- export_icums_21_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_exp
    
    # Overview in table with top 20 cif each month
    top10_fob_month_export <- export_icums_21_clean %>%
      group_by(month) %>%
      arrange(-fob) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:10) %>%
      ungroup() %>%
      arrange(-fob)
    
    # Overview of 0 values FOB 
    fob_0_export <- export_icums_21_clean %>%
      filter(fob == 0) 
    
    # Make plot
    exp_top10_plot <-  ggplot(top10_fob_month_export, # Note: filtered out the one extreme observation
                              aes(x = factor(month_name, levels = month.name), 
                                  y = fob, 
                                  fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Export, fob (in GHC)", fill = "Rank",
           title = "Monthly maximum single exports in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    exp_top10_plot
  }
  
  ### Re-Export checks ###
  {
    # Yearly totals
    yearly_sum_re_exp <- re_export_icums_21_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_re_exp
    
    # Summary statistics per month
    monthly_sum_re_exp <- re_export_icums_21_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_re_exp
    
    # Overview in table with top 20 cif each month
    top10_fob_month_re_export <- re_export_icums_21_clean %>%
      group_by(month) %>%
      arrange(-fob) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:10) %>%
      ungroup() %>%
      arrange(-fob)
    
    # Overview of 0 values FOB 
    fob_0_re_export <- re_export_icums_21_clean %>%
      filter(cif == 0) 
    
    # Make plot
    re_exp_top10_plot <- ggplot(top10_fob_month_re_export,
                                aes(x = factor(month_name, levels = month.name), 
                                    y = fob, 
                                    fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Re-Export, fob (in GHC)", fill = "Rank",
           title = "Monthly maximum single re-exports in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    re_exp_top10_plot
  }
  
  ### Save checks into Excel - top 10  ###
  {
    # Create workbook and fill with data and plots
    {
      wb <- createWorkbook()
      # Import
      # Create sheet
      imp_sheet <- addWorksheet(wb, "Import") 
      # Add row with NA value
      writeData(wb, sheet = imp_sheet, na_imp_cif_21,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add dataframe
      writeData(wb, sheet = imp_sheet, top10_cif_month_import,
                startCol = 1, startRow = 25,rowNames = FALSE)
      # Add plot
      imp_top10_plot
      insertPlot(wb, sheet = imp_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Re-import
      # Create sheet
      re_imp_sheet <- addWorksheet(wb, "Re-Import") 
      # Add dataframe
      writeData(wb, sheet = re_imp_sheet, top10_cif_month_re_import,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add plot
      re_imp_top10_plot
      insertPlot(wb, sheet = re_imp_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Warehousing
      # Create sheet
      wh_sheet <- addWorksheet(wb, "Warehousing") 
      # Add dataframe
      writeData(wb, sheet = wh_sheet, top10_cif_month_wh,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add plot
      wh_top10_plot
      insertPlot(wb, sheet = wh_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Regime 9
      # Create sheet
      reg9_sheet <- addWorksheet(wb, "Regime 9") 
      # Add the negative observation
      writeData(wb, sheet = reg9_sheet, neg_reg9_21,
                startCol = 1, startRow = 22,rowNames = FALSE)
       # Add dataframe
      writeData(wb, sheet = reg9_sheet, top10_cif_month_reg9,
                startCol = 1, startRow = 25,rowNames = FALSE)
      # Add plot
      reg9_top10_plot
      insertPlot(wb, sheet = reg9_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Export
      # Create sheet
      exp_sheet <- addWorksheet(wb, "Export") 
      # Add dataframe
      writeData(wb, sheet = exp_sheet, top10_fob_month_export,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add plot
      exp_top10_plot
      insertPlot(wb, sheet = exp_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Re-Export
      # Create sheet
      re_exp_sheet <- addWorksheet(wb, "Re-Export") 
      # Add dataframe
      writeData(wb, sheet = re_exp_sheet, top10_fob_month_re_export,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add plot
      re_exp_top10_plot
      insertPlot(wb, sheet = re_exp_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Save workbook to excel
      saveWorkbook(wb, "total/output/ICUMS21_datacheck_top10.xlsx", overwrite = TRUE)
      
    }
    
  }
  
  ### Save checks into Excel - zero cif and fob values ###
  {
    # Create workbook and fill with data and plots
    {
      wb <- createWorkbook()
      # Import
      # Create sheet
      imp_sheet <- addWorksheet(wb, "Import") 
      # Add dataframe
      writeData(wb, sheet = imp_sheet, cif_0_import,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Re-import
      # Create sheet
      re_imp_sheet <- addWorksheet(wb, "Re-Import") 
      # Add dataframe
      writeData(wb, sheet = re_imp_sheet, cif_0_re_import,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Warehousing
      # Create sheet
      wh_sheet <- addWorksheet(wb, "Warehousing") 
      # Add dataframe
      writeData(wb, sheet = wh_sheet, cif_0_wh,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Regime 9
      # Create sheet
      reg9_sheet <- addWorksheet(wb, "Regime 9") 
      # Add dataframe
      writeData(wb, sheet = reg9_sheet, cif_0_reg9,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Export
      # Create sheet
      exp_sheet <- addWorksheet(wb, "Export") 
      # Add dataframe
      writeData(wb, sheet = exp_sheet, fob_0_export,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Re-Export
      # Create sheet
      re_exp_sheet <- addWorksheet(wb, "Re-Export") 
      # Add dataframe
      writeData(wb, sheet = re_exp_sheet, fob_0_re_export,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Save workbook to excel
      saveWorkbook(wb, "total/output/ICUMS21_cif_fob_0.xlsx", overwrite = TRUE)
      
    }
    
    
  }
}

# Remove outliers from data --> for now best option, need to consult with ICUMS (GhanaLink or customs?)
# And make monthly datasets
{
  # Import outlier removing
  {
    # Outlier removing
    import_icums_21_final <- import_icums_21_clean %>%
      filter(!is.na(cif), cif < 300000000) # drop the one NA value
    # Check new summary statistics
    monthly_sum_imp_new <- import_icums_21_final %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_imp_new
    
    # Create new dataset
    import_icums_21_month <- import_icums_21_final %>%
      ungroup() %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
    
  }
  
  # Re-Import outlier removing
  {
    # Outlier removing
    re_import_icums_21_final <- re_import_icums_21_clean %>%
      filter(cif < 300000000)
    # Check new summary statistics
    monthly_sum_re_imp_new <- re_import_icums_21_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_re_imp_new
    
    # Create new dataset
    re_import_icums_21_month <- re_import_icums_21_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  # Warehousing outlier removing
  {
    # Outlier removing
    wh_icums_21_final <- wh_icums_21_clean %>%
      filter(cif < 300000000)
    # Check new summary statistics
    monthly_sum_wh_new <- wh_icums_21_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_wh_new
    
    # Create new dataset
    wh_icums_21_month <- wh_icums_21_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  # Regime 9 outlier removing
  {
    # Outlier removing
    reg9_icums_21_final <- reg9_icums_21_clean %>%
      filter(cif > 0, cif < 300000000) # Drop negative observation
    # Check new summary statistics
    monthly_sum_reg9_new <- reg9_icums_21_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_reg9_new
    
    # Create new dataset
    reg9_icums_21_month <- reg9_icums_21_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  # Export outlier removing
  {
    # Outlier removing
    export_icums_21_final <- export_icums_21_clean %>%
      filter(cif < 300000000)
    # Check new summary statistics
    monthly_sum_exp_new <- export_icums_21_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_exp_new
    
    # Create new dataset
    export_icums_21_month <- export_icums_21_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
    
  }
  
  # Re-Export outlier removing
  {
    # Outlier removing
    re_export_icums_21_final <- re_export_icums_21_clean %>%
      filter(cif < 300000000)
    # Check new summary statistics
    monthly_sum_re_exp_new <- re_export_icums_21_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_re_exp_new
    
    # Create new dataset
    re_export_icums_21_month <- re_export_icums_21_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  
}

# ALTERNATIVE = READ TOTAL FROM WORKSPACE!
{
  load("total/input/icums_total_21.RData")
}

# Merge import, re_import, warehousing, reg9, export, re_export all together
{
  # Merge all data
  icums_total_21 <- rbind(import_icums_21_final,
                          re_import_icums_21_final,
                          wh_icums_21_final,
                          reg9_icums_21_final,
                          export_icums_21_final,
                          re_export_icums_21_final)
  
  # Check totals
  # Import
  total_imp <- icums_total_21 %>%
    filter(tradeflow == "Import",
           re == 0,
           warehouse == 0,
           reg9 == 0) %>%
    summarise(sum(cif, na.rm = TRUE))
  total_imp
  sum(monthly_sum_imp_new$sum_cif)
  # Warehousing
  total_wh <- icums_total_21 %>%
    filter(tradeflow == "Import",
           re == 0,
           warehouse == 1,
           reg9 == 0) %>%
    summarise(sum(cif))
  total_wh
  sum(monthly_sum_wh_new$sum_cif)
  # All fine! No further check necessary
  
  # Drop dataframes
  rm(import_icums_21_input, import_icums_21_clean, import_icums_21_month, import_icums_21_final,
     re_import_icums_21_input, re_import_icums_21_clean, re_import_icums_21_month, re_import_icums_21_final,
     wh_icums_21_input, wh_icums_21_clean, wh_icums_21_month, wh_icums_21_final,
     reg9_icums_21_input, reg9_icums_21_clean, reg9_icums_21_month, reg9_icums_21_final,
     export_icums_21_input, export_icums_21_clean, export_icums_21_month, export_icums_21_final,
     re_export_icums_21_input, re_export_icums_21_clean, re_export_icums_21_month, re_export_icums_21_final,
     monthly_sum_imp_new, monthly_sum_re_imp_new, monthly_sum_wh_new, monthly_sum_reg9_new,
     monthly_sum_exp_new, monthly_sum_re_exp_new,
     total_imp, total_wh)
  
  # rm(list=(ls()[ls()!="icums_total_21"]))

  
}

# Using total data, now clean it and add columns to produce figures
{
  # Make data monthly = necessary, as we only use clean (dropped high observations) data, not monthly
  month_icums_total_21 <- icums_total_21 %>%
    group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
    summarise(cif = sum(cif),
              fob = sum(fob),
              net_mass = sum(net_mass),
              gross_mass = sum(gross_mass)) %>%
    ungroup()

  rm(icums_total_21)
  
  # Add label to HS codes --> gives us: month_icums_total_22_hs
  {
    hs_codes <- read_excel("data/HS_CODES.xlsx", col_names = FALSE)
    # Rename columns 
    colnames(hs_codes) <- c("hs_code", "hs_label")
    
    # Update HS codes dataframe
    hs_codes <- hs_codes %>% 
      mutate(hs2 = substr(hs_code, 1, 2),
             hs4 = ifelse(nchar(hs_code)>3, substr(hs_code, 1, 4), NA),
             hs10 = ifelse(nchar(hs_code)>9, substr(hs_code, 1, 10), NA)) %>%
      arrange(hs2, hs4, hs10) %>% 
      mutate(hs2_cat = ifelse(is.na(hs4) & !is.na(hs2), hs_label, NA),
             hs4_cat = ifelse(is.na(hs10) & !is.na(hs4), hs_label, NA),
             hs10_cat = ifelse(!is.na(hs10), hs_label, NA)) %>%
      fill(hs10_cat, .direction = "up") %>% 
      fill(hs4_cat, .direction = "up") %>% 
      fill(hs2_cat, .direction = "up") %>% 
      mutate(hs10_cat = ifelse(nchar(hs_code) < 10, NA, hs10_cat),
             hs4_cat = ifelse(nchar(hs_code) < 4, NA, hs4_cat),
             hs2_cat = ifelse(nchar(hs_code) < 2, NA, hs2_cat)) %>%
      select(!c(hs2, hs4, hs10, hs_label)) %>%
      mutate(hs2_cat =  paste0(toupper(substr(hs2_cat, 1, 1)), 
                               tolower(substr(hs2_cat, 2, nchar(hs2_cat)))),
             hs4_cat =  paste0(toupper(substr(hs4_cat, 1, 1)), 
                               tolower(substr(hs4_cat, 2, nchar(hs4_cat)))),
             hs10_cat =  paste0(toupper(substr(hs10_cat, 1, 1)), 
                                tolower(substr(hs10_cat, 2, nchar(hs10_cat))))) %>%
      filter(nchar(hs_code) == 10)
    
    # Seperately match on hs2
    hs_codes_2 <- hs_codes %>%
      mutate(hs2 = substr(hs_code, 1,2)) %>%
      select(hs2, hs2_cat) %>%
      group_by(hs2) %>%
      summarise(hs2_cat = unique(hs2_cat))
    
    # Match hs2 label to data
    month_icums_total_21_hs2 <- month_icums_total_21 %>%
      mutate(hs2 = substr(hs_code, 1, 2))
    month_icums_total_21_hs2 <- left_join(month_icums_total_21_hs2, hs_codes_2) 
    
    # Now match hs4 and hs10 codes as well
    hs_codes_rest <- hs_codes %>%
      select(-hs2_cat)
    month_icums_total_21_hs <- left_join(month_icums_total_21_hs2, hs_codes_rest) 
    
    # WARNING: THERE ARE 42 HS CODES WE CANNOT MATCH fully, all are matched on hs2 though
    sum(is.na(month_icums_total_21_hs$hs10_cat))
    test <- month_icums_total_21_hs[is.na(month_icums_total_21_hs$hs2_cat), ]
    
  }
  
  # Change country names from abbreviation to full names
  {
    # Read abbreviation country name matching file
    country <- read_excel("data/country_abbreviations.xlsx", col_names = TRUE) %>%
      # Add some extra abbreviations
      add_row(Country = c("Netherlands Antilles", "Unknown", "Serbia and Montenegro", "Midway Islands",
                    "Unknown", "Unknown", "East Timor", "Unknown"),
              Abbreviation = c("AN", "ZZ", "YU", "MI", 
                    "ZN", "OR", "TP", NA))
    
    month_icums_total_21_hs_country <- left_join(month_icums_total_21_hs, 
                                                 country, 
                                                 by = c("country_abb" = "Abbreviation")) %>%
      rename(country = Country)
    
    month_icums_total_21_hs_country <- month_icums_total_21_hs_country %>%
      mutate(country = case_when(reg9 == 1 ~ country_abb, 
                                 reg9 == 0 ~ country),
             country = ifelse(is.na(country), "Unknown", country)) 
    
    sum(is.na(month_icums_total_21_hs_country$country))
    unique(month_icums_total_21_hs_country$country)
    
    rm(country)
  }
  
  # Add continents - STILL HAVE TO DO THIS!!!!
  {
    # Read continent matching to country file
    continent <- read.csv2("data/country_continent.csv")
    # Include all necessary countries to continent dataset
    continent <- rbind(continent, c("Antarctica", "Antarctica"), 
                       c("Netherlands Antilles", "South America"), 
                       c("Congo (the Democratic Republic of the)", "Africa"),
                       c("C?te D'Ivoire", "Africa"),
                       c("Korea", "Asia"),
                       c("Swaziland", "Africa"),
                       c("Unknown", "Unknown"),
                       c("British Indian Ocean Territory", "Asia"),
                       c("Christmas Island", "Asia"),
                       c("Lao People's Democratic Republic ","Asia"),
                       c("Yugoslavia", "Europe"),
                       c("Midway islands", "Oceania"),
                       c("Cocos (Keeling) Islands", "Asia"),
                       c("Brunei Darussalam","Asia"),
                       c("East Timor", "Asia"),
                       c("Holy See (the) [Vatican City State]", "Europe")) %>%
      filter(country != "South Korea", country != "North Korea",
             country != "Congo (the Democratic Republic of the)")
    
    # Merge continents to data
    month_icums_total_22_hs_country_cont <- stringdist_join(month_icums_total_22_hs_country, continent, 
                                                            by = "country", #match based on team
                                                            mode = 'left', #use left join
                                                            method = "jw", #use jw distance metric
                                                            max_dist = 0.3, 
                                                            distance_col ='dist') %>%
      group_by(country.x) %>%
      slice_min(order_by = dist, n = 1) %>% # Only select the best match
      ungroup() %>%
      select(!c(country.x, dist)) %>%
      rename(country = country.y)
  }
  
  
  
  icums_total_21_clean <- month_icums_total_21_hs_country %>%
    mutate(#year_quarter =  as.yearqtr(date, format = '%Y Q%q'),
           #quarter =  str_sub(year_quarter, start = -1),
           type = case_when(reg9 == 1 ~ "Regime 9",
                            re == 1 ~ paste0("Re-", tradeflow),
                            warehouse == 1 ~ "Warehouse",
                            TRUE ~ tradeflow))
  
  #rm(list=(ls()[ls()!="icums_total_21_clean"]))
  
}

# ALTERNATIVE = READ CLEAN MONTHLY DATA FROM WORKSPACE!
{
  load("total/input/icums_total_21_clean.RData")
  
}

### FIGURES ###

# Import and export per month
{
    # Create monthly dataset
    monthly_21 <- icums_total_21_clean %>%
      group_by(tradeflow, month, month_name, type) %>%
      summarise(cif = sum(cif),
                fob = sum(fob))
    
    # Import
    ggplot(filter(monthly_21, tradeflow == "Import"), 
           aes(x = factor(month_name, levels = month.name), 
               y = cif/10^9, 
               fill = factor(type, levels =  c("Regime 9",
                                               "Warehouse",
                                               "Re-Import",
                                               "Import")))) +
      geom_bar(stat = "identity") +
      blank_theme2 +
      labs(x = NULL, y = "Import (billion GHC)", fill = NULL)
    
    ggsave("total/output/import_monthly_21.png", height = 6, width = 9)
    
    # Export
    ggplot(filter(monthly_21, tradeflow == "Export"), 
           aes(x = factor(month_name, levels = month.name), 
               y = cif/10^9, 
               fill = factor(type, levels =  c("Re-Export", "Export")))) +
      geom_bar(stat = "identity") +
      blank_theme2 +
      labs(x = NULL, y = "Export (billion GHC)", fill = NULL)
    
    ggsave("total/output/export_monthly_21.png", height = 6, width = 9)
  }
  
# Sunburst HS2 category
{
  # Split up in HS2 category
  cat_first_21 <- icums_total_21_clean %>%
    group_by(tradeflow, hs2_cat) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = hs2_cat) %>%
    rename(labels = hs2_cat) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  # Make sunburst import
  sunburst_hs2_imp_21 <- plot_ly(
    data = filter(cat_first_21, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif)
  
  # Save in 1100, 600 format
  sunburst_hs2_imp_21
  
  # Make sunburst import without regime 9
  # Split up in HS2 category
  cat_first_21_noreg9 <- icums_total_21_clean %>%
    filter(reg9 == 0) %>%
    group_by(tradeflow, hs2_cat) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = hs2_cat) %>%
    rename(labels = hs2_cat) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  sunburst_hs2_imp_21_noreg9 <- plot_ly(
    data = filter(cat_first_21_noreg9, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif)
  
  # Save in 1100, 600 format
  sunburst_hs2_imp_21_noreg9
  
  # Make sunburst export
  sunburst_hs2_exp_21 <- plot_ly(
    data = filter(cat_first_21, tradeflow == "Export"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_fob,
    parents= ~parents,
    ids = ~ids,
    text = ~share_fob)
  
  # Save in 1100, 600 format
  sunburst_hs2_exp_21
  
}

# Sunburst HS2 + country
{
  # Split up in HS2 category first
  cat_country_21_step1 <- icums_total_21_clean %>%
    group_by(tradeflow, hs2_cat) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = hs2_cat) %>%
    rename(labels = hs2_cat) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  # Split up in hs2 and then country
  cat_country_21_step2 <- icums_total_21_clean %>%
    group_by(tradeflow, hs2_cat, country) %>%
    mutate(parents = hs2_cat) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob),
              parents = parents[1],
              ids = paste(parents[1], "-", country[1])) %>%
    rename(labels = country) %>%
    ungroup() %>%
    group_by(parents, tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = "")) %>%
    ungroup() %>%
    select(-hs2_cat)
  
  
  # Combine for sunburst
  cat_country_21 <- do.call("rbind",
                            list(cat_country_21_step1, cat_country_21_step2))
  
  
  rm(cat_country_21_step1, cat_country_21_step2)
  
  # Create import sunburst
  sunburst_cat_country_imp_21 <- plot_ly(
    data = filter(cat_country_21, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif)
  
  # Save in 1100, 600 format
  sunburst_cat_country_imp_21
  
  # Drop regime 9
  {
    # Split up in HS2 category first
    cat_country_21_step1 <- icums_total_21_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, hs2_cat) %>%
      summarise(values_cif = sum(cif),
                values_fob = sum(fob)) %>%
      mutate(parents = "",
             ids = hs2_cat) %>%
      rename(labels = hs2_cat) %>%
      group_by(tradeflow) %>%
      mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
             share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
      ungroup() 
    
    # Split up in hs2 and then country
    cat_country_21_step2 <- icums_total_21_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, hs2_cat, country) %>%
      mutate(parents = hs2_cat) %>%
      summarise(values_cif = sum(cif),
                values_fob = sum(fob),
                parents = parents[1],
                ids = paste(parents[1], "-", country[1])) %>%
      rename(labels = country) %>%
      ungroup() %>%
      group_by(parents, tradeflow) %>%
      mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
             share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = "")) %>%
      ungroup() %>%
      select(-hs2_cat)
    
    
    # Combine for sunburst
    cat_country_21_noreg9 <- do.call("rbind",
                                     list(cat_country_21_step1, cat_country_21_step2))
    
    
    rm(cat_country_21_step1, cat_country_21_step2)
    
    # Create import sunburst
    sunburst_cat_country_21_noreg9 <- plot_ly(
      data = filter(cat_country_21_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif)
    
    # Save in 1100, 600 format
    sunburst_cat_country_21_noreg9
    
  }
  
  # Make sunburst export
  sunburst_cat_country_exp_21 <- plot_ly(
    data = filter(cat_country_21, tradeflow == "Export"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_fob,
    parents= ~parents,
    ids = ~ids,
    text = ~share_fob)
  
  # Save in 1100, 600 format
  sunburst_cat_country_exp_21
  
}

# Sunburst country
{
  # Split up in country
  country_first_21 <- icums_total_21_clean %>%
    group_by(tradeflow, country) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = country) %>%
    rename(labels = country) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  # Make sunburst import
  sunburst_country_imp_21 <- plot_ly(
    data = filter(country_first_21, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif)
  
  # Save in 1100, 600 format
  sunburst_country_imp_21
  
  # Make sunburst import without regime 9
  # Split up in country
  country_first_21_noreg9 <- icums_total_21_clean %>%
    filter(reg9 == 0) %>%
    group_by(tradeflow, country) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = country) %>%
    rename(labels = country) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  sunburst_country_imp_21_noreg9 <- plot_ly(
    data = filter(country_first_21_noreg9, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif)
  
  # Save in 1100, 600 format
  sunburst_country_imp_21_noreg9
  
  # Make sunburst export
  sunburst_country_exp_21 <- plot_ly(
    data = filter(country_first_21, tradeflow == "Export"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_fob,
    parents= ~parents,
    ids = ~ids,
    text = ~share_fob)
  
  # Save in 1100, 600 format
  sunburst_country_exp_21
  
  
}

# Sunburst country + HS2
{
  # Split up in country first
  country_cat_21_step1 <- icums_total_21_clean %>%
    group_by(tradeflow, country) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = country) %>%
    rename(labels = country) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  # Split up in country then hs2
  country_cat_21_step2 <- icums_total_21_clean %>%
    group_by(tradeflow, country, hs2_cat) %>%
    mutate(parents = country) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob),
              parents = parents[1],
              ids = paste(parents[1], "-", hs2_cat[1])) %>%
    rename(labels = hs2_cat) %>%
    ungroup() %>%
    group_by(parents, tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = "")) %>%
    ungroup() %>%
    select(-country)
  
  
  # Combine for sunburst
  country_cat_21 <- do.call("rbind",
                            list(country_cat_21_step1, country_cat_21_step2))
  
  
  rm(country_cat_21_step1, country_cat_21_step2)
  
  # Create import sunburst
  sunburst_country_cat_imp_21 <- plot_ly(
    data = filter(country_cat_21, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif)
  
  # Save in 1100, 600 format
  sunburst_country_cat_imp_21
  
  # Drop regime 9
  {
    # Split up in country first
    country_cat_21_step1 <- icums_total_21_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, country) %>%
      summarise(values_cif = sum(cif),
                values_fob = sum(fob)) %>%
      mutate(parents = "",
             ids = country) %>%
      rename(labels = country) %>%
      group_by(tradeflow) %>%
      mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
             share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
      ungroup() 
    
    # Split up in hs2 and then country
    country_cat_21_step2 <- icums_total_21_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, country, hs2_cat) %>%
      mutate(parents = country) %>%
      summarise(values_cif = sum(cif),
                values_fob = sum(fob),
                parents = parents[1],
                ids = paste(parents[1], "-", hs2_cat[1])) %>%
      rename(labels = hs2_cat) %>%
      ungroup() %>%
      group_by(parents, tradeflow) %>%
      mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
             share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = "")) %>%
      ungroup() %>%
      select(-country)
    
    
    # Combine for sunburst
    country_cat_21_noreg9 <- do.call("rbind",
                                     list(country_cat_21_step1, country_cat_21_step2))
    
    
    rm(country_cat_21_step1, country_cat_21_step2)
    
    # Create import sunburst no reg9
    sunburst_country_cat_21_noreg9 <- plot_ly(
      data = filter(country_cat_21_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif)
    
    # Save in 1100, 600 format
    sunburst_country_cat_21_noreg9
    
  }
  
  # Make sunburst export
  sunburst_country_cat_exp_21 <- plot_ly(
    data = filter(country_cat_21, tradeflow == "Export"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_fob,
    parents= ~parents,
    ids = ~ids,
    text = ~share_fob)
  
  # Save in 1100, 600 format
  sunburst_country_cat_exp_21
  
}


# Data request: 2021
{

  # Yearly: to select top hs codes
  {
    hs10_data_req_year <- icums_total_21_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, year, hs10_cat, hs4_cat, hs2_cat, hs_code) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
    hs4_data_req_year <- icums_total_21_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, year, hs4_cat, hs2_cat) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
    hs2_data_req_year <- icums_total_21_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, year, hs2_cat) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  
  # Monthly = FINAL EXTRACTION
  # Create monthly export and import totals based on hs10 code
  data_req <- icums_total_21_clean %>%
    ungroup() %>%
    filter(reg9 == 0, # No regime 9
           hs_code != "4907000000") %>% # Drop banknotes from data
    group_by(tradeflow, year, month, month_name, hs10_cat, hs4_cat, hs2_cat, hs_code) %>%
    summarise(value_exp = sum(fob),
              value_imp = sum(cif))
  
  # Select top 10 categories first
  {
    # First create yearly totals per hs10
    hs10_data_req_year <- data_req %>%
      group_by(tradeflow, year, hs10_cat, hs4_cat, hs2_cat, hs_code) %>%
      summarise(value_exp = sum(value_exp),
                value_imp = sum(value_imp))
    
    # Export
    top10_export_hs10 <- hs10_data_req_year %>%
      filter(tradeflow == "Export") %>%
      arrange(-value_exp) %>%
      head(10) %>%
      pull(hs_code)
    
    # Import
    top10_import_hs10 <- hs10_data_req_year %>%
      filter(tradeflow == "Import") %>%
      arrange(-value_imp) %>%
      head(10) %>%
      pull(hs_code)
    }
  
  # Export
  {
    # Separate the top 10
    export_top10 <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Export",
             hs_code %in% top10_export_hs10) %>%
      select(-month, -value_imp) %>%
      pivot_wider(names_from = month_name, values_from = value_exp) %>%
      mutate(yearly_total = rowSums(across(January:December), na.rm = T)) %>%
      arrange(-yearly_total)
    
    # Add the other items
    export_others <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Export",
             !(hs_code %in% top10_export_hs10)) %>%
      group_by(year, tradeflow, month, month_name) %>%
      summarise(value_exp = sum(value_exp)) %>%
      ungroup() %>%
      select(-month) %>%
      pivot_wider(names_from = month_name, values_from = value_exp) %>%
      mutate(yearly_total = rowSums(across(January:December), na.rm = T),
             hs10_cat = "Others", hs4_cat = "", hs2_cat = "", hs_code = "")
    
    # Add the total
    export_totals <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Export") %>%
      group_by(year, tradeflow, month, month_name) %>%
      summarise(value_exp = sum(value_exp)) %>%
      ungroup() %>%
      select(-month) %>%
      pivot_wider(names_from = month_name, values_from = value_exp)  %>%
      mutate(yearly_total = rowSums(across(January:December), na.rm = T),
             hs10_cat = "Total", hs4_cat = "", hs2_cat = "", hs_code = "")
    
    # Merge
    export_table <- rbind(export_top10, export_others, export_totals)
  }
  
  # Import
  {
    # Seperate the top 10
    import_top10 <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Import",
             hs_code %in% top10_import_hs10) %>%
      select(-month, -value_exp) %>%
      pivot_wider(names_from = month_name, values_from = value_imp) %>%
      mutate(yearly_total = rowSums(across(January:December), na.rm = T)) %>%
      arrange(-yearly_total)
    
    # Add the other items
    import_others <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Import",
             !(hs_code %in% top10_import_hs10)) %>%
      group_by(year, tradeflow, month, month_name) %>%
      summarise(value_imp = sum(value_imp)) %>%
      ungroup() %>%
      select(-month) %>%
      pivot_wider(names_from = month_name, values_from = value_imp) %>%
      mutate(yearly_total = rowSums(across(January:December), na.rm = T),
             hs10_cat = "Others", hs4_cat = "", hs2_cat = "", hs_code = "")
    
    # Add the total
    import_totals <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Import") %>%
      group_by(year, tradeflow, month, month_name) %>%
      summarise(value_imp = sum(value_imp)) %>%
      ungroup() %>%
      select(-month) %>%
      pivot_wider(names_from = month_name, values_from = value_imp) %>%
      mutate(yearly_total = rowSums(across(January:December), na.rm = T),
             hs10_cat = "Total", hs4_cat = "", hs2_cat = "", hs_code = "")
    
    # Merge
    import_table <- rbind(import_top10, import_others, import_totals)
  }
  
  # Save into Excel
  # Create workbook
  wb_request <- createWorkbook()
  # Add sheet
  addWorksheet(wb_request, "Trade_data") 
  
  # Add dataframe Export
  writeData(wb_request, sheet = "Trade_data", export_table,
            startCol = 1, startRow = 1,rowNames = FALSE)
  
  # Add dataframe Import
  writeData(wb_request, sheet = "Trade_data", import_table,
            startCol = 1, startRow = 15,rowNames = FALSE)
  
  # Save workbook to excel
  saveWorkbook(wb_request, "total/output/trade_export_import_summary_2021.xlsx", overwrite = TRUE)
  
  
  
}


###################################
############## 2020 ###############
###################################

# Read 2020 Icums data - OR LOAD DATA DIRECTLY FROM R WORKSPACE!!!
{
  # Path for all data files 
  pathname_icums_20 <- "data/raw_data/ICUMS DATA 2020"
  # File list of all files in 2020 data
  icums_file_list_20 <- list.files(pathname_icums_20)
  
  ### Read Import ###
  # Create file list
  icums_import_file_list_20 <- icums_file_list_20[grepl("Merchandised Import", icums_file_list_20)]
  # Make list of all excel sheets
  import_icums_20 <- lapply(icums_import_file_list_20, function(x) { # This function loops over all files
    sheets <- readxl::excel_sheets(paste(pathname_icums_20, x, sep = "/")) # Per file it gives us a list of sheet names
    lapply(sheets, function(y) { # This function then loops over all sheets
      readxl::read_excel(paste(pathname_icums_20, x, sep = "/"), 
                         sheet = y, 
                         col_names = TRUE, skip = 4)
    })
  })
  
  # Now make into dataframe, by unlisting and binding rows
  import_icums_20_list <- unlist(import_icums_20, recursive = FALSE)
  import_icums_20_input <- do.call("bind_rows", import_icums_20_list)
  
  ### Read Re-Import ###
  # Create file list
  icums_re_import_file_list_20 <- icums_file_list_20[grepl("Merchandised Re-Import", icums_file_list_20)]
  # Make list of all excel sheets
  re_import_icums_20 <- lapply(icums_re_import_file_list_20, function(x) { # This function loops over all files
    sheets <- readxl::excel_sheets(paste(pathname_icums_20, x, sep = "/")) # Per file it gives us a list of sheet names
    lapply(sheets, function(y) { # This function then loops over all sheets
      readxl::read_excel(paste(pathname_icums_20, x, sep = "/"),
                         sheet = y, 
                         col_names = TRUE, skip = 4)
    })
  })
  
  # Now make into dataframe, by unlisting and binding rows
  re_import_icums_20_list <- unlist(re_import_icums_20, recursive = FALSE)
  re_import_icums_20_input <- do.call("bind_rows", re_import_icums_20_list)
  
  ### Read Warehousing ###
  # Create file list
  icums_wh_file_list_20 <- icums_file_list_20[grepl("Warehousing", icums_file_list_20)]
  # Make list of all excel sheets
  wh_icums_20 <- lapply(icums_wh_file_list_20, function(x) { # This function loops over all files
    sheets <- readxl::excel_sheets(paste(pathname_icums_20, x, sep = "/")) # Per file it gives us a list of sheet names
    lapply(sheets, function(y) { # This function then loops over all sheets
      readxl::read_excel(paste(pathname_icums_20, x, sep = "/"), 
                         sheet = y, 
                         col_names = TRUE, skip = 4)
    })
  })
  
  # Now make into dataframe, by unlisting and binding rows
  wh_icums_20_list <- unlist(wh_icums_20, recursive = FALSE)
  wh_icums_20_input <- do.call("bind_rows", wh_icums_20_list)
  
  
  ### Read Regime 9 ###
  # Pathname reg 9
  pathname_icums_reg9 <- "data/raw_data/REGIME 9"
  # File list of all files of regime 9
  icums_reg9_file_list <- list.files(pathname_icums_reg9)
  # Create file list
  icums_reg9_file_list_20 <- icums_reg9_file_list[grepl("2020", icums_reg9_file_list) &
                                                   !grepl("MARCH", icums_reg9_file_list) ]
  # Make list of all excel sheets
  reg9_icums_20 <- lapply(icums_reg9_file_list_20, function(x) { # This function loops over all files
    sheets <- readxl::excel_sheets(paste(pathname_icums_reg9, x, sep = "/")) # Per file it gives us a list of sheet names
    lapply(sheets, function(y) { # This function then loops over all sheets
      readxl::read_excel(paste(pathname_icums_reg9, x, sep = "/"), 
                         sheet = y, 
                         col_names = TRUE, skip = 5)
    })
  })
  
  # Now make into dataframe, by unlisting and binding rows
  reg9_icums_20_list <- unlist(reg9_icums_20, recursive = FALSE)
  reg9_icums_20_input <- do.call("bind_rows", reg9_icums_20_list)
  
  
  ### Read Export ###
  # Create file list
  icums_export_file_list_20 <- icums_file_list_20[grepl("Merchandised Export", icums_file_list_20)]
  # Make list of all excel sheets
  export_icums_20 <- lapply(icums_export_file_list_20, function(x) { # This function loops over all files
    sheets <- readxl::excel_sheets(paste(pathname_icums_20, x, sep = "/")) # Per file it gives us a list of sheet names
    lapply(sheets, function(y) { # This function then loops over all sheets
      readxl::read_excel(paste(pathname_icums_20, x, sep = "/"), 
                         sheet = y, 
                         col_names = TRUE, skip = 4)
    })
  })
  
  # Now make into dataframe, by unlisting and binding rows
  export_icums_20_list <- unlist(export_icums_20, recursive = FALSE)
  export_icums_20_input <- do.call("bind_rows", export_icums_20_list)
  
  ### Read Re-Export ###
  # Create file list
  icums_re_export_file_list_20 <- icums_file_list_20[grepl("Merchandised Re-Export", icums_file_list_20)]
  # Make list of all excel sheets
  re_export_icums_20 <- lapply(icums_re_export_file_list_20, function(x) { # This function loops over all files
    sheets <- readxl::excel_sheets(paste(pathname_icums_20, x, sep = "/")) # Per file it gives us a list of sheet names
    lapply(sheets, function(y) { # This function then loops over all sheets
      readxl::read_excel(paste(pathname_icums_20, x, sep = "/"), 
                         sheet = y, 
                         col_names = TRUE, skip = 4)
    })
  })
  
  # Now make into dataframe, by unlisting and binding rows
  re_export_icums_20_list <- unlist(re_export_icums_20, recursive = FALSE)
  re_export_icums_20_input <- do.call("bind_rows", re_export_icums_20_list)
  
  ### Drop dataframes ###
  rm(pathname_icums_20, icums_file_list_20,
     icums_import_file_list_20, import_icums_20, import_icums_20_list,
     icums_re_import_file_list_20, re_import_icums_20, re_import_icums_20_list,
     icums_wh_file_list_20, wh_icums_20, wh_icums_20_list,
     pathname_icums_reg9, icums_reg9_file_list, icums_reg9_file_list_20, reg9_icums_20, reg9_icums_20_list,
     icums_export_file_list_20, export_icums_20, export_icums_20_list,
     icums_re_export_file_list_20, re_export_icums_20, re_export_icums_20_list)
  
}

# ALTERNATIVE = READ RAW FROM WORKSPACE!
{
  load("total/input/raw_icums_20.RData")
}

# Rename columns and select, same format for every type of input
{
  # Clean Import
  import_icums_20_clean <- import_icums_20_input %>%
    mutate(date = convert_to_date(HEAD_TIME_PROC, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 0,
           re = 0,
           reg9 = 0,
           tradeflow = "Import") %>%
    rename(hs_code = ITEMS_HS_CODE,
           country_abb = HEAD_COUNTRY_ORIG_DEST,
           country_cons = COUNTRY_OF_CONSIGNMENT,
           cif = ITEMS_CIF_GHC,
           fob = ITEMS_FOB_GHC,
           net_mass = ITEMS_NET_MASS,
           gross_mass = ITEMS_GROSS_MASS,
           desc = ITEMS_GOODS_DESC,
           head_cust_off = HEAD_CUST_OFF_CODE,
           head_decl_no = HEAD_DECL_NO,
           head_declarant_id = HEAD_DECLARANT_ID,
           head_declarant_name = HEAD_DECLARANT_NAME,
           head_porter_code = HEAD_IMPORTER_CODE,
           head_porter_name = HEAD_IMPORTER_NAME) %>%
    select(tradeflow, date, year, month, month_name, day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re, reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Clean Re-Import
  re_import_icums_20_clean <- re_import_icums_20_input %>%
    mutate(date = convert_to_date(HEAD_TIME_PROC, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 0,
           re = 1,
           reg9 = 0,
           tradeflow = "Import") %>%
    rename(hs_code = ITEMS_HS_CODE,
           country_abb = HEAD_COUNTRY_ORIG_DEST,
           country_cons = COUNTRY_OF_CONSIGNMENT,
           cif = ITEMS_CIF_GHC,
           fob = ITEMS_FOB_GHC,
           net_mass = ITEMS_NET_MASS,
           gross_mass = ITEMS_GROSS_MASS,
           desc = ITEMS_GOODS_DESC,
           head_cust_off = HEAD_CUST_OFF_CODE,
           head_decl_no = HEAD_DECL_NO,
           head_declarant_id = HEAD_DECLARANT_ID,
           head_declarant_name = HEAD_DECLARANT_NAME,
           head_porter_code = HEAD_IMPORTER_CODE,
           head_porter_name = HEAD_IMPORTER_NAME) %>%
    select(tradeflow, date, year, month, month_name, day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re, reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Clean Warehousing
  wh_icums_20_clean <- wh_icums_20_input %>%
    mutate(date = convert_to_date(BOE_ISSUE_DATE, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 1,
           re = 0,
           reg9 = 0,
           head_cust_off = NA,
           head_porter_code = NA,
           country_cons = COUNTRY_OF_SHIPMENT, # As no country of consignment, add it as country of shipment
           tradeflow = "Import") %>% 
    rename(hs_code = ITEMS_HS_CODE,
           country_abb = COUNTRY_OF_SHIPMENT,
           cif = ITEMS_CIF_GHC,
           fob = ITEMS_FOB_GHC,
           net_mass = ITEMS_NET_MASS,
           gross_mass = ITEMS_GROSS_MASS,
           desc = ITEMS_GOODS_DESC,
           head_declarant_id = HEAD_DECLARANT_ID,
           head_declarant_name = HEAD_DECLARANT_NAME,
           head_porter_name = HEAD_IMPORTER_NAME,
           head_decl_no = BOE_NUMBER) %>%
    select(tradeflow, date, year, month, month_name, day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re, reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Clean Regime 9
  reg9_icums_20_clean <- reg9_icums_20_input %>%
    mutate(date = convert_to_date(BOE_DECLARATION_DATE, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 0,
           re = 0,
           reg9 = 1,
           tradeflow = "Import",
           head_declarant_id = NA, # NOT IN DATA
           head_declarant_name = NA, # NOT IN DATA
           net_mass = NA # NOT IN DATA
    ) %>%
    rename(hs_code = ITEM_HS_CODE, # ITEM INSTEAD OF ITEMS
           country_abb = COUNTRY_OF_ORIGIN, #DIFF, FULL NAMES
           country_cons = COUNTRY_OF_CONSIGNMENT, # DIFF FULL NAMES
           cif = ITEM_CIF_GHS, # ITEM NOT S AND GHS NOT GHC
           fob = ITEM_FOB_GHS, # ITEM NOT S AND GHS NOT GHC
           gross_mass = ITEM_GROSS_WEIGHT_KG, # DIFF
           desc = ITEM_GOODS_DESCRIPTION, # DESCRIPTION INSTEAD OF DESC
           head_cust_off = CUSTOMS_CLEARANCE_OFFICE, # INSTEAD OF HEAD_CUST_OFF_CODE
           head_porter_code = IMPORTER_TIN, # MAYBE IMPORTER_TIN?
           head_porter_name = IMPORTER_NAME, # NO HEAD
           head_decl_no = BOE_NO) %>% 
    select(tradeflow, date, year, month, month_name, day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re, reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Clean Export
  export_icums_20_clean <- export_icums_20_input %>%
    mutate(date = convert_to_date(HEAD_TIME_PROC, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 0,
           re = 0,
           reg9 = 0,
           tradeflow = "Export") %>%
    rename(hs_code = ITEMS_HS_CODE,
           country_abb = HEAD_COUNTRY_ORIG_DEST,
           country_cons = COUNTRY_OF_CONSIGNMENT,
           cif = ITEMS_CIF_GHC,
           fob = ITEMS_FOB_GHC,
           net_mass = ITEMS_NET_MASS,
           gross_mass = ITEMS_GROSS_MASS,
           desc = ITEMS_GOODS_DESC,
           head_cust_off = HEAD_CUST_OFF_CODE,
           head_decl_no = HEAD_DECL_NO,
           head_declarant_id = HEAD_DECLARANT_ID,
           head_declarant_name = HEAD_DECLARANT_NAME,
           head_porter_code = HEAD_EXPORTER_CODE,
           head_porter_name = HEAD_EXPORTER_NAME) %>%
    select(tradeflow, date, year, month, month_name, day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re, reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Clean Re-Export
  re_export_icums_20_clean <- re_export_icums_20_input %>%
    mutate(date = convert_to_date(HEAD_TIME_PROC, character_fun = lubridate::dmy),
           year = as.numeric(format(date, "%Y")),
           month = as.numeric(format(date, "%m")),
           month_name = month.name[month],
           day = as.numeric(format(date, "%d")),
           warehouse = 0,
           re = 1,
           reg9 = 0,
           tradeflow = "Export") %>%
    rename(hs_code = ITEMS_HS_CODE,
           country_abb = HEAD_COUNTRY_ORIG_DEST,
           country_cons = COUNTRY_OF_CONSIGNMENT,
           cif = ITEMS_CIF_GHC,
           fob = ITEMS_FOB_GHC,
           net_mass = ITEMS_NET_MASS,
           gross_mass = ITEMS_GROSS_MASS,
           desc = ITEMS_GOODS_DESC,
           head_cust_off = HEAD_CUST_OFF_CODE,
           head_decl_no = HEAD_DECL_NO,
           head_declarant_id = HEAD_DECLARANT_ID,
           head_declarant_name = HEAD_DECLARANT_NAME,
           head_porter_code = HEAD_EXPORTER_CODE,
           head_porter_name = HEAD_EXPORTER_NAME) %>%
    select(tradeflow, date, year, month, month_name,day, hs_code, country_abb, country_cons,
           cif, fob, net_mass, gross_mass, desc, warehouse, re,reg9,
           head_cust_off, head_decl_no, head_declarant_id, head_declarant_name,
           head_porter_code, head_porter_name)
  
  # Drop raw dataframes
  rm(import_icums_20_input, re_import_icums_20_input, wh_icums_20_input,
     reg9_icums_20_input, export_icums_20_input, re_export_icums_20_input)
}

# ALTERNATIVE = READ RAW FROM WORKSPACE!
{
  load("total/input/raw_icums_20_clean.RData")
}

# First sanity checks
{
  ### Import checks ###
  {
    # Yearly totals
    yearly_sum_imp <- import_icums_20_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif, na.rm = TRUE)/10^6,
                max_cif = max(cif, na.rm = TRUE)/10^6,
                sum_cif = sum(cif, na.rm = TRUE)/10^9,
                min_fob = min(fob, na.rm = TRUE)/10^6,
                max_fob = max(fob, na.rm = TRUE)/10^6,
                sum_fob = sum(fob, na.rm = TRUE)/10^9,
                sum_na_cif = sum(is.na(cif)))
    yearly_sum_imp
    
    # Negative values cif!!!
    neg_imp_cif_20 <- import_icums_20_clean %>%
      filter(cif < 0)
    neg_imp_cif_20
    
    # Summary statistics per month
    monthly_sum_imp <- import_icums_20_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif, na.rm = TRUE)/10^6,
                max_cif = max(cif, na.rm = TRUE)/10^6,
                sum_cif = sum(cif, na.rm = TRUE)/10^6,
                min_fob = min(fob, na.rm = TRUE)/10^6,
                max_fob = max(fob, na.rm = TRUE)/10^6,
                sum_fob = sum(fob, na.rm = TRUE)/10^6,
                sum_na_cif = sum(is.na(cif)))
    monthly_sum_imp
    
    # Overview in table with top 50 cif each month
    top10_cif_month_import <- import_icums_20_clean %>%
      group_by(month) %>%
      arrange(-cif) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:10) %>%
      ungroup() %>%
      arrange(-cif)
    
    # Overview of 0 values CIF 
    cif_0_import <- import_icums_20_clean %>%
      filter(cif == 0) 
    
    # Make plot
    imp_top10_plot <-  ggplot(top10_cif_month_import,
                              aes(x = factor(month_name, levels = month.name), 
                                  y = cif, 
                                  fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Import, cif (in GHC)", fill = "Rank",
           title = "Monthly maximum single imports in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    imp_top10_plot
    
  }
  
  ### Re-Import checks ###
  {
    # Yearly totals
    yearly_sum_re_imp <- re_import_icums_20_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_re_imp
    
    # Summary statistics per month
    monthly_sum_re_imp <- re_import_icums_20_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_re_imp
    
    # Overview in table with top 50 cif each month
    top10_cif_month_re_import <- re_import_icums_20_clean %>%
      group_by(month) %>%
      arrange(-cif) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:length(cif)) %>% # length(cif) as not 50 for every month
      ungroup() %>%
      arrange(-cif)
    
    # Overview of 0 values CIF 
    cif_0_re_import <- re_import_icums_20_clean %>%
      filter(cif == 0) 
    
    # Make plot
    re_imp_top10_plot <- ggplot(top10_cif_month_re_import,
                                aes(x = factor(month_name, levels = month.name), 
                                    y = cif, 
                                    fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Re-Import, cif (in GHC)", fill = "Rank",
           title = "Monthly maximum single re-imports in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    re_imp_top10_plot
  }
  
  ### Warehousing checks ###
  {
    # Yearly totals
    yearly_sum_wh <- wh_icums_20_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_wh
    
    # Negative value cif!!!
    neg_wh_cif_20 <- wh_icums_20_clean %>%
      filter(cif < 0)
    neg_wh_cif_20
    
    # Summary statistics per month
    monthly_sum_wh <- wh_icums_20_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_wh
    
    # Overview in table with top 50 cif each month
    top10_cif_month_wh <- wh_icums_20_clean %>%
      group_by(month) %>%
      arrange(-cif) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:10) %>%
      ungroup() %>%
      arrange(-cif)
    
    # Overview of 0 values CIF 
    cif_0_wh <- wh_icums_20_clean %>%
      filter(cif == 0) 
    
    # Make plot
    wh_top10_plot <- ggplot(top10_cif_month_wh,
                            aes(x = factor(month_name, levels = month.name), 
                                y = cif, 
                                fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Warehousing, cif (in GHC)", fill = "Rank",
           title = "Monthly maximum single warehousing in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    wh_top10_plot
  }
  
  ### Regime 9 checks ###
  {
    # Yearly totals
    yearly_sum_reg9 <- reg9_icums_20_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_reg9
    
    # Negative values cif!!!
    neg_reg9_20 <- reg9_icums_20_clean %>%
      filter(cif < 0)
    neg_reg9_20
    
    # Summary statistics per month
    monthly_sum_reg9 <- reg9_icums_20_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_reg9
    
    # Overview in table with top 50 cif each month
    top10_cif_month_reg9 <- reg9_icums_20_clean %>%
      group_by(month) %>%
      arrange(-cif) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:10) %>%
      ungroup() %>%
      arrange(-cif)
    
    # Overview of 0 values CIF 
    cif_0_reg9 <- reg9_icums_20_clean %>%
      filter(cif == 0) 
    
    # Make plot
    reg9_top10_plot <-  ggplot(top10_cif_month_reg9,
                               aes(x = factor(month_name, levels = month.name), 
                                   y = cif, 
                                   fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Regime 9, cif (in GHC)", fill = "Rank",
           title = "Monthly maximum single regime 9 in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    reg9_top10_plot
    
  }
  
  ### Export checks ###
  {
    # Yearly totals
    yearly_sum_exp <- export_icums_20_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_exp
    
    # Summary statistics per month
    monthly_sum_exp <- export_icums_20_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_exp
    
    # Overview in table with top 20 cif each month
    top10_fob_month_export <- export_icums_20_clean %>%
      group_by(month) %>%
      arrange(-fob) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:10) %>%
      ungroup() %>%
      arrange(-fob)
    
    # Overview of 0 values FOB 
    fob_0_export <- export_icums_20_clean %>%
      filter(fob == 0) 
    
    # Make plot
    exp_top10_plot <-  ggplot(top10_fob_month_export, # Note: filtered out the one extreme observation
                              aes(x = factor(month_name, levels = month.name), 
                                  y = fob, 
                                  fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Export, fob (in GHC)", fill = "Rank",
           title = "Monthly maximum single exports in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    exp_top10_plot
  }
  
  ### Re-Export checks ###
  {
    # Yearly totals
    yearly_sum_re_exp <- re_export_icums_20_clean %>%
      summarise(unique_months = length(unique(month)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^9,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^9)
    yearly_sum_re_exp
    
    # Summary statistics per month
    monthly_sum_re_exp <- re_export_icums_20_clean %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_re_exp
    
    # Overview in table with top 20 cif each month
    top10_fob_month_re_export <- re_export_icums_20_clean %>%
      group_by(month) %>%
      arrange(-fob) %>%
      do(head(., 10)) %>%
      mutate(rank = 1:length(cif)) %>% # As not always 50 observations
      ungroup() %>%
      arrange(-fob)
    
    # Overview of 0 values FOB 
    fob_0_re_export <- re_export_icums_20_clean %>%
      filter(cif == 0) 
    
    # Make plot
    re_exp_top10_plot <- ggplot(top10_fob_month_re_export,
                                aes(x = factor(month_name, levels = month.name), 
                                    y = fob, 
                                    fill = factor(rank))) + 
      geom_bar(stat = "identity", position = "dodge") +
      blank_theme2 +
      labs(x = "Month", y = "Re-Export, fob (in GHC)", fill = "Rank",
           title = "Monthly maximum single re-exports in Ghana") +
      theme(axis.text.x = element_text(angle = -90),
            legend.position = "none")
    
    re_exp_top10_plot
  }
  
  ### Save checks into Excel - top 10 ###
  {
    # Create workbook and fill with data and plots
    {
      wb <- createWorkbook()
      # Import
      # Create sheet
      imp_sheet <- addWorksheet(wb, "Import") 
      # Add negative cif values
      writeData(wb, sheet = imp_sheet, neg_imp_cif_20,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add dataframe
      writeData(wb, sheet = imp_sheet, top10_cif_month_import,
                startCol = 1, startRow = 31,rowNames = FALSE)
      # Add plot
      imp_top10_plot
      insertPlot(wb, sheet = imp_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Re-import
      # Create sheet
      re_imp_sheet <- addWorksheet(wb, "Re-Import") 
      # Add dataframe
      writeData(wb, sheet = re_imp_sheet, top10_cif_month_re_import,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add plot
      re_imp_top10_plot
      insertPlot(wb, sheet = re_imp_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Warehousing
      # Create sheet
      wh_sheet <- addWorksheet(wb, "Warehousing") 
      # Add negative cif values
      writeData(wb, sheet = wh_sheet, neg_wh_cif_20,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add dataframe
      writeData(wb, sheet = wh_sheet, top10_cif_month_wh,
                startCol = 1, startRow = 25,rowNames = FALSE)
      # Add plot
      wh_top10_plot
      insertPlot(wb, sheet = wh_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Regime 9
      # Create sheet
      reg9_sheet <- addWorksheet(wb, "Regime 9") 
      # Add the negative observation
      writeData(wb, sheet = reg9_sheet, neg_reg9_20,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add dataframe
      writeData(wb, sheet = reg9_sheet, top10_cif_month_reg9,
                startCol = 1, startRow = 33,rowNames = FALSE)
      # Add plot
      reg9_top10_plot
      insertPlot(wb, sheet = reg9_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Export
      # Create sheet
      exp_sheet <- addWorksheet(wb, "Export") 
      # Add dataframe
      writeData(wb, sheet = exp_sheet, top10_fob_month_export,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add plot
      exp_top10_plot
      insertPlot(wb, sheet = exp_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Re-Export
      # Create sheet
      re_exp_sheet <- addWorksheet(wb, "Re-Export") 
      # Add dataframe
      writeData(wb, sheet = re_exp_sheet, top10_fob_month_re_export,
                startCol = 1, startRow = 22,rowNames = FALSE)
      # Add plot
      re_exp_top10_plot
      insertPlot(wb, sheet = re_exp_sheet, startRow = 1, startCol = 1,
                 width = 8, height = 4)
      
      # Save workbook to excel
      saveWorkbook(wb, "total/output/ICUMS20_datacheck_top10.xlsx", overwrite = TRUE)
      
    }
    
  }
  
  ### Save checks into Excel - zero cif and fob values ###
  {
    # Create workbook and fill with data and plots
    {
      wb <- createWorkbook()
      # Import
      # Create sheet
      imp_sheet <- addWorksheet(wb, "Import") 
      # Add dataframe
      writeData(wb, sheet = imp_sheet, cif_0_import,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Re-import
      # Create sheet
      re_imp_sheet <- addWorksheet(wb, "Re-Import") 
      # Add dataframe
      writeData(wb, sheet = re_imp_sheet, cif_0_re_import,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Warehousing
      # Create sheet
      wh_sheet <- addWorksheet(wb, "Warehousing") 
      # Add dataframe
      writeData(wb, sheet = wh_sheet, cif_0_wh,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Regime 9
      # Create sheet
      reg9_sheet <- addWorksheet(wb, "Regime 9") 
      # Add dataframe
      writeData(wb, sheet = reg9_sheet, cif_0_reg9,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Export
      # Create sheet
      exp_sheet <- addWorksheet(wb, "Export") 
      # Add dataframe
      writeData(wb, sheet = exp_sheet, fob_0_export,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Re-Export
      # Create sheet
      re_exp_sheet <- addWorksheet(wb, "Re-Export") 
      # Add dataframe
      writeData(wb, sheet = re_exp_sheet, fob_0_re_export,
                startCol = 1, startRow = 1,rowNames = FALSE)
      
      # Save workbook to excel
      saveWorkbook(wb, "total/output/ICUMS20_cif_fob_0.xlsx", overwrite = TRUE)
      
    }
    
    
  }

}

# Remove outliers from data --> for now best option, need to consult with ICUMS (GhanaLink or customs?)
# And make monthly datasets
{
  # Import outlier removing
  {
    # Outlier removing
    import_icums_20_final <- import_icums_20_clean %>%
      filter(cif >= 0, cif < 300000000) # drop the one NA value
    # Check new summary statistics
    monthly_sum_imp_new <- import_icums_20_final %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_imp_new
    
    # Create new dataset
    import_icums_20_month <- import_icums_20_final %>%
      ungroup() %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
    
  }
  
  # Re-Import outlier removing
  {
    # Outlier removing
    re_import_icums_20_final <- re_import_icums_20_clean %>%
      filter(cif < 300000000)
    # Check new summary statistics
    monthly_sum_re_imp_new <- re_import_icums_20_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_re_imp_new
    
    # Create new dataset
    re_import_icums_20_month <- re_import_icums_20_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  # Warehousing outlier removing
  {
    # Outlier removing
    wh_icums_20_final <- wh_icums_20_clean %>%
      filter(cif >= 0, cif < 300000000)
    # Check new summary statistics
    monthly_sum_wh_new <- wh_icums_20_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_wh_new
    
    # Create new dataset
    wh_icums_20_month <- wh_icums_20_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  # Regime 9 outlier removing
  {
    # Outlier removing
    reg9_icums_20_final <- reg9_icums_20_clean %>%
      filter(cif >= 0, cif < 300000000) # Drop negative observation
    # Check new summary statistics
    monthly_sum_reg9_new <- reg9_icums_20_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_reg9_new
    
    # Create new dataset
    reg9_icums_20_month <- reg9_icums_20_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  # Export outlier removing
  {
    # Outlier removing
    export_icums_20_final <- export_icums_20_clean %>%
      filter(cif < 300000000)
    # Check new summary statistics
    monthly_sum_exp_new <- export_icums_20_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_exp_new
    
    # Create new dataset
    export_icums_20_month <- export_icums_20_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
    
  }
  
  # Re-Export outlier removing
  {
    # Outlier removing
    re_export_icums_20_final <- re_export_icums_20_clean %>%
      filter(cif < 300000000)
    # Check new summary statistics
    monthly_sum_re_exp_new <- re_export_icums_20_final %>%
      group_by(month) %>%
      summarise(unique_days = length(unique(day)),
                min_cif = min(cif)/10^6,
                max_cif = max(cif)/10^6,
                sum_cif = sum(cif)/10^6,
                min_fob = min(fob)/10^6,
                max_fob = max(fob)/10^6,
                sum_fob = sum(fob)/10^6)
    monthly_sum_re_exp_new
    
    # Create new dataset
    re_export_icums_20_month <- re_export_icums_20_final %>%
      group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  
}

# ALTERNATIVE = READ TOTAL FROM WORKSPACE!
{
  load("total/input/icums_total_20.RData")
}

# Merge import, re_import, warehousing, reg9, export, re_export all together
{
  # Merge all data
  icums_total_20 <- rbind(import_icums_20_final,
                          re_import_icums_20_final,
                          wh_icums_20_final,
                          reg9_icums_20_final,
                          export_icums_20_final,
                          re_export_icums_20_final)
  
  # Check totals
  # Import
  total_imp <- icums_total_20 %>%
    filter(tradeflow == "Import",
           re == 0,
           warehouse == 0,
           reg9 == 0) %>%
    summarise(sum(cif, na.rm = TRUE))
  total_imp
  sum(monthly_sum_imp_new$sum_cif)
  # Warehousing
  total_wh <- icums_total_20 %>%
    filter(tradeflow == "Import",
           re == 0,
           warehouse == 1,
           reg9 == 0) %>%
    summarise(sum(cif))
  total_wh
  sum(monthly_sum_wh_new$sum_cif)
  # All fine! No further check necessary
  
  # Drop dataframes
  rm(import_icums_20_input, import_icums_20_clean, import_icums_20_month, import_icums_20_final,
     re_import_icums_20_input, re_import_icums_20_clean, re_import_icums_20_month, re_import_icums_20_final,
     wh_icums_20_input, wh_icums_20_clean, wh_icums_20_month, wh_icums_20_final,
     reg9_icums_20_input, reg9_icums_20_clean, reg9_icums_20_month, reg9_icums_20_final,
     export_icums_20_input, export_icums_20_clean, export_icums_20_month, export_icums_20_final,
     re_export_icums_20_input, re_export_icums_20_clean, re_export_icums_20_month, re_export_icums_20_final,
     monthly_sum_imp_new, monthly_sum_re_imp_new, monthly_sum_wh_new, monthly_sum_reg9_new,
     monthly_sum_exp_new, monthly_sum_re_exp_new,
     total_imp, total_wh)
  
}

# Using total data, now clean it and add columns to produce figures
{
  # Make data monthly - CHECK IF NECESSARY!!!
  month_icums_total_20 <- icums_total_20 %>%
    group_by(tradeflow, year, month, month_name, hs_code, country_abb, warehouse, re, reg9) %>%
    summarise(cif = sum(cif),
              fob = sum(fob),
              net_mass = sum(net_mass),
              gross_mass = sum(gross_mass)) %>%
    ungroup()
  
  rm(icums_total_20)
  
  # Add label to HS codes --> gives us: month_icums_total_22_hs
  {
    hs_codes <- read_excel("data/HS_CODES.xlsx", col_names = FALSE)
    # Rename columns 
    colnames(hs_codes) <- c("hs_code", "hs_label")
    
    # Update HS codes dataframe
    hs_codes <- hs_codes %>% 
      mutate(hs2 = substr(hs_code, 1, 2),
             hs4 = ifelse(nchar(hs_code)>3, substr(hs_code, 1, 4), NA),
             hs10 = ifelse(nchar(hs_code)>9, substr(hs_code, 1, 10), NA)) %>%
      arrange(hs2, hs4, hs10) %>% 
      mutate(hs2_cat = ifelse(is.na(hs4) & !is.na(hs2), hs_label, NA),
             hs4_cat = ifelse(is.na(hs10) & !is.na(hs4), hs_label, NA),
             hs10_cat = ifelse(!is.na(hs10), hs_label, NA)) %>%
      fill(hs10_cat, .direction = "up") %>% 
      fill(hs4_cat, .direction = "up") %>% 
      fill(hs2_cat, .direction = "up") %>% 
      mutate(hs10_cat = ifelse(nchar(hs_code) < 10, NA, hs10_cat),
             hs4_cat = ifelse(nchar(hs_code) < 4, NA, hs4_cat),
             hs2_cat = ifelse(nchar(hs_code) < 2, NA, hs2_cat)) %>%
      select(!c(hs2, hs4, hs10, hs_label)) %>%
      mutate(hs2_cat =  paste0(toupper(substr(hs2_cat, 1, 1)), 
                               tolower(substr(hs2_cat, 2, nchar(hs2_cat)))),
             hs4_cat =  paste0(toupper(substr(hs4_cat, 1, 1)), 
                               tolower(substr(hs4_cat, 2, nchar(hs4_cat)))),
             hs10_cat =  paste0(toupper(substr(hs10_cat, 1, 1)), 
                                tolower(substr(hs10_cat, 2, nchar(hs10_cat))))) %>%
      filter(nchar(hs_code) == 10)
    
    # Seperately match on hs2
    hs_codes_2 <- hs_codes %>%
      mutate(hs2 = substr(hs_code, 1,2)) %>%
      select(hs2, hs2_cat) %>%
      group_by(hs2) %>%
      summarise(hs2_cat = unique(hs2_cat))
    
    # Match hs2 label to data
    month_icums_total_20_hs2 <- month_icums_total_20 %>%
      mutate(hs2 = substr(hs_code, 1, 2))
    month_icums_total_20_hs2 <- left_join(month_icums_total_20_hs2, hs_codes_2) 
    
    # Now match hs4 and hs10 codes as well
    hs_codes_rest <- hs_codes %>%
      select(-hs2_cat)
    month_icums_total_20_hs <- left_join(month_icums_total_20_hs2, hs_codes_rest) 
    
    # WARNING: THERE ARE 52 HS CODES WE CANNOT MATCH fully, all are matched on hs2 though
    sum(is.na(month_icums_total_20_hs$hs10_cat))
    test <- month_icums_total_20_hs[is.na(month_icums_total_20_hs$hs2_cat), ]
    
  }
  
  # Change country names from abbreviation to full names
  {
    # Read abbreviation country name matching file
    country <- read_excel("data/country_abbreviations.xlsx", col_names = TRUE) %>%
      # Add some extra abbreviations
      add_row(Country = c("Netherlands Antilles", "Unknown", "Serbia and Montenegro", "Midway Islands",
                          "Unknown", "Unknown", "East Timor", "Unknown"),
              Abbreviation = c("AN", "ZZ", "YU", "MI", 
                               "ZN", "OR", "TP", NA))
    
    month_icums_total_20_hs_country <- left_join(month_icums_total_20_hs, 
                                                 country, 
                                                 by = c("country_abb" = "Abbreviation")) %>%
      rename(country = Country)
    
    month_icums_total_20_hs_country <- month_icums_total_20_hs_country %>%
      mutate(country = case_when(reg9 == 1 ~ country_abb, 
                                 reg9 == 0 ~ country),
             country = ifelse(is.na(country), "Unknown", country)) 
    
    # Check NA countries
    sum(is.na(month_icums_total_20_hs_country$country))
    unique(month_icums_total_20_hs_country$country)
    
    rm(country)
  }
  
  # Add continents - STILL HAVE TO DO THIS!!!!
  {
    # Read continent matching to country file
    continent <- read.csv2("data/country_continent.csv")
    # Include all necessary countries to continent dataset
    continent <- rbind(continent, c("Antarctica", "Antarctica"), 
                       c("Netherlands Antilles", "South America"), 
                       c("Congo (the Democratic Republic of the)", "Africa"),
                       c("C?te D'Ivoire", "Africa"),
                       c("Korea", "Asia"),
                       c("Swaziland", "Africa"),
                       c("Unknown", "Unknown"),
                       c("British Indian Ocean Territory", "Asia"),
                       c("Christmas Island", "Asia"),
                       c("Lao People's Democratic Republic ","Asia"),
                       c("Yugoslavia", "Europe"),
                       c("Midway islands", "Oceania"),
                       c("Cocos (Keeling) Islands", "Asia"),
                       c("Brunei Darussalam","Asia"),
                       c("East Timor", "Asia"),
                       c("Holy See (the) [Vatican City State]", "Europe")) %>%
      filter(country != "South Korea", country != "North Korea",
             country != "Congo (the Democratic Republic of the)")
    
    # Merge continents to data
    month_icums_total_22_hs_country_cont <- stringdist_join(month_icums_total_22_hs_country, continent, 
                                                            by = "country", #match based on team
                                                            mode = 'left', #use left join
                                                            method = "jw", #use jw distance metric
                                                            max_dist = 0.3, 
                                                            distance_col ='dist') %>%
      group_by(country.x) %>%
      slice_min(order_by = dist, n = 1) %>% # Only select the best match
      ungroup() %>%
      select(!c(country.x, dist)) %>%
      rename(country = country.y)
  }
  
  
  
  icums_total_20_clean <- month_icums_total_20_hs_country %>%
    mutate(#year_quarter =  as.yearqtr(date, format = '%Y Q%q'),
      #quarter =  str_sub(year_quarter, start = -1),
      type = case_when(reg9 == 1 ~ "Regime 9",
                       re == 1 ~ paste0("Re-", tradeflow),
                       warehouse == 1 ~ "Warehouse",
                       TRUE ~ tradeflow))
  
}

# ALTERNATIVE = READ CLEAN MONTHLY DATA FROM WORKSPACE!
{
  load("total/input/icums_total_20_clean.RData")
  
}

### FIGURES ###

# Import and export per month
{
  # Create monthly dataset
  monthly_20 <- icums_total_20_clean %>%
    group_by(tradeflow, month, month_name, type) %>%
    summarise(cif = sum(cif),
              fob = sum(fob))
  
  # Import
  ggplot(filter(monthly_20, tradeflow == "Import"), 
         aes(x = factor(month_name, levels = month.name), 
             y = cif/10^9, 
             fill = factor(type, levels =  c("Regime 9",
                                             "Warehouse",
                                             "Re-Import",
                                             "Import")))) +
    geom_bar(stat = "identity") +
    blank_theme2 +
    labs(x = NULL, y = "Import (billion GHC)", fill = NULL)
  
  ggsave("total/output/import_monthly_20.png", height = 6, width = 9)
  
  # Export
  ggplot(filter(monthly_20, tradeflow == "Export"), 
         aes(x = factor(month_name, levels = month.name), 
             y = cif/10^9, 
             fill = factor(type, levels =  c("Re-Export", "Export")))) +
    geom_bar(stat = "identity") +
    blank_theme2 +
    labs(x = NULL, y = "Export (billion GHC)", fill = NULL)
  
  ggsave("total/output/export_monthly_20.png", height = 6, width = 9)
}

# Sunburst HS2 category
{
  # Split up in HS2 category
  cat_first_20 <- icums_total_20_clean %>%
    group_by(tradeflow, hs2_cat) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = hs2_cat) %>%
    rename(labels = hs2_cat) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  # Make sunburst import
  sunburst_hs2_imp_20 <- plot_ly(
    data = filter(cat_first_20, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif)
  
  # Save in 1100, 600 format
  sunburst_hs2_imp_20
  
  # Make sunburst import without regime 9
  # Split up in HS2 category
  cat_first_20_noreg9 <- icums_total_20_clean %>%
    filter(reg9 == 0) %>%
    group_by(tradeflow, hs2_cat) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = hs2_cat) %>%
    rename(labels = hs2_cat) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  sunburst_hs2_imp_20_noreg9 <- plot_ly(
    data = filter(cat_first_20_noreg9, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif)
  
  # Save in 1100, 600 format
  sunburst_hs2_imp_20_noreg9
  
  # Make sunburst export
  sunburst_hs2_exp_20 <- plot_ly(
    data = filter(cat_first_20, tradeflow == "Export"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_fob,
    parents= ~parents,
    ids = ~ids,
    text = ~share_fob)
  
  # Save in 1100, 600 format
  sunburst_hs2_exp_20
  
}

# Sunburst HS2 + country
{
  # Split up in HS2 category first
  cat_country_20_step1 <- icums_total_20_clean %>%
    group_by(tradeflow, hs2_cat) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = hs2_cat) %>%
    rename(labels = hs2_cat) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  # Split up in hs2 and then country
  cat_country_20_step2 <- icums_total_20_clean %>%
    group_by(tradeflow, hs2_cat, country) %>%
    mutate(parents = hs2_cat) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob),
              parents = parents[1],
              ids = paste(parents[1], "-", country[1])) %>%
    rename(labels = country) %>%
    ungroup() %>%
    group_by(parents, tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = "")) %>%
    ungroup() %>%
    select(-hs2_cat)
  
  
  # Combine for sunburst
  cat_country_20 <- do.call("rbind",
                            list(cat_country_20_step1, cat_country_20_step2))
  
  
  rm(cat_country_20_step1, cat_country_20_step2)
  
  # Create import sunburst
  sunburst_cat_country_imp_20 <- plot_ly(
    data = filter(cat_country_20, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif)
  
  # Save in 1100, 600 format
  sunburst_cat_country_imp_20
  
  # Drop regime 9
  {
    # Split up in HS2 category first
    cat_country_20_step1 <- icums_total_20_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, hs2_cat) %>%
      summarise(values_cif = sum(cif),
                values_fob = sum(fob)) %>%
      mutate(parents = "",
             ids = hs2_cat) %>%
      rename(labels = hs2_cat) %>%
      group_by(tradeflow) %>%
      mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
             share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
      ungroup() 
    
    # Split up in hs2 and then country
    cat_country_20_step2 <- icums_total_20_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, hs2_cat, country) %>%
      mutate(parents = hs2_cat) %>%
      summarise(values_cif = sum(cif),
                values_fob = sum(fob),
                parents = parents[1],
                ids = paste(parents[1], "-", country[1])) %>%
      rename(labels = country) %>%
      ungroup() %>%
      group_by(parents, tradeflow) %>%
      mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
             share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = "")) %>%
      ungroup() %>%
      select(-hs2_cat)
    
    
    # Combine for sunburst
    cat_country_20_noreg9 <- do.call("rbind",
                                     list(cat_country_20_step1, cat_country_20_step2))
    
    
    rm(cat_country_20_step1, cat_country_20_step2)
    
    # Create import sunburst
    sunburst_cat_country_20_noreg9 <- plot_ly(
      data = filter(cat_country_20_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif)
    
    # Save in 1100, 600 format
    sunburst_cat_country_20_noreg9
    
  }
  
  # Make sunburst export
  sunburst_cat_country_exp_20 <- plot_ly(
    data = filter(cat_country_20, tradeflow == "Export"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_fob,
    parents= ~parents,
    ids = ~ids,
    text = ~share_fob)
  
  # Save in 1100, 600 format
  sunburst_cat_country_exp_20
  
}

# Sunburst country
{
  # Split up in country
  country_first_20 <- icums_total_20_clean %>%
    group_by(tradeflow, country) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = country) %>%
    rename(labels = country) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  # Make sunburst import
  sunburst_country_imp_20 <- plot_ly(
    data = filter(country_first_20, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif)
  
  # Save in 1100, 600 format
  sunburst_country_imp_20
  
  # Make sunburst import without regime 9
  # Split up in country
  country_first_20_noreg9 <- icums_total_20_clean %>%
    filter(reg9 == 0) %>%
    group_by(tradeflow, country) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = country) %>%
    rename(labels = country) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  sunburst_country_imp_20_noreg9 <- plot_ly(
    data = filter(country_first_20_noreg9, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif)
  
  # Save in 1100, 600 format
  sunburst_country_imp_20_noreg9
  
  # Make sunburst export
  sunburst_country_exp_20 <- plot_ly(
    data = filter(country_first_20, tradeflow == "Export"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_fob,
    parents= ~parents,
    ids = ~ids,
    text = ~share_fob)
  
  # Save in 1100, 600 format
  sunburst_country_exp_20
  
  
}

# Sunburst country + HS2
{
  # Split up in country first
  country_cat_20_step1 <- icums_total_20_clean %>%
    group_by(tradeflow, country) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob)) %>%
    mutate(parents = "",
           ids = country) %>%
    rename(labels = country) %>%
    group_by(tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
    ungroup() 
  
  # Split up in country then hs2
  country_cat_20_step2 <- icums_total_20_clean %>%
    group_by(tradeflow, country, hs2_cat) %>%
    mutate(parents = country) %>%
    summarise(values_cif = sum(cif),
              values_fob = sum(fob),
              parents = parents[1],
              ids = paste(parents[1], "-", hs2_cat[1])) %>%
    rename(labels = hs2_cat) %>%
    ungroup() %>%
    group_by(parents, tradeflow) %>%
    mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
           share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = "")) %>%
    ungroup() %>%
    select(-country)
  
  
  # Combine for sunburst
  country_cat_20 <- do.call("rbind",
                            list(country_cat_20_step1, country_cat_20_step2))
  
  
  rm(country_cat_20_step1, country_cat_20_step2)
  
  # Create import sunburst
  sunburst_country_cat_imp_20 <- plot_ly(
    data = filter(country_cat_20, tradeflow == "Import"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_cif,
    parents= ~parents,
    ids = ~ids,
    text = ~share_cif)
  
  # Save in 1100, 600 format
  sunburst_country_cat_imp_20
  
  # Drop regime 9
  {
    # Split up in country first
    country_cat_20_step1 <- icums_total_20_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, country) %>%
      summarise(values_cif = sum(cif),
                values_fob = sum(fob)) %>%
      mutate(parents = "",
             ids = country) %>%
      rename(labels = country) %>%
      group_by(tradeflow) %>%
      mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
             share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = ""))  %>%
      ungroup() 
    
    # Split up in hs2 and then country
    country_cat_20_step2 <- icums_total_20_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, country, hs2_cat) %>%
      mutate(parents = country) %>%
      summarise(values_cif = sum(cif),
                values_fob = sum(fob),
                parents = parents[1],
                ids = paste(parents[1], "-", hs2_cat[1])) %>%
      rename(labels = hs2_cat) %>%
      ungroup() %>%
      group_by(parents, tradeflow) %>%
      mutate(share_cif = paste(round(100*values_cif / sum(values_cif), 1), "%", sep = ""),
             share_fob = paste(round(100*values_fob / sum(values_fob), 1), "%", sep = "")) %>%
      ungroup() %>%
      select(-country)
    
    
    # Combine for sunburst
    country_cat_20_noreg9 <- do.call("rbind",
                                     list(country_cat_20_step1, country_cat_20_step2))
    
    
    rm(country_cat_20_step1, country_cat_20_step2)
    
    # Create import sunburst no reg9
    sunburst_country_cat_20_noreg9 <- plot_ly(
      data = filter(country_cat_20_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif)
    
    # Save in 1100, 600 format
    sunburst_country_cat_20_noreg9
    
  }
  
  # Make sunburst export
  sunburst_country_cat_exp_20 <- plot_ly(
    data = filter(country_cat_20, tradeflow == "Export"),
    branchvalues="total",
    type='sunburst',
    labels = ~labels,
    values = ~values_fob,
    parents= ~parents,
    ids = ~ids,
    text = ~share_fob)
  
  # Save in 1100, 600 format
  sunburst_country_cat_exp_20
  
}


# Data request: 2020
{
  # Yearly: to select top hs codes
  {
    hs10_data_req_year <- icums_total_20_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, year, hs10_cat, hs4_cat, hs2_cat, hs_code) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
    hs4_data_req_year <- icums_total_20_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, year, hs4_cat, hs2_cat) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
    hs2_data_req_year <- icums_total_20_clean %>%
      filter(reg9 == 0) %>%
      group_by(tradeflow, year, hs2_cat) %>%
      summarise(cif = sum(cif),
                fob = sum(fob),
                net_mass = sum(net_mass),
                gross_mass = sum(gross_mass))
  }
  
  
  # Monthly = FINAL EXTRACTION
  # Create monthly export and import totals based on hs10 code
  data_req <- icums_total_20_clean %>%
    ungroup() %>%
    filter(reg9 == 0, # No regime 9
           hs_code != "4907000000") %>% # Drop banknotes from data
    group_by(tradeflow, year, month, month_name, hs10_cat, hs4_cat, hs2_cat, hs_code) %>%
    summarise(value_exp = sum(fob),
              value_imp = sum(cif))
  
  # Select top 10 categories first
  {
    # First create yearly totals per hs10
    hs10_data_req_year <- data_req %>%
      group_by(tradeflow, year, hs10_cat, hs4_cat, hs2_cat, hs_code) %>%
      summarise(value_exp = sum(value_exp),
                value_imp = sum(value_imp))
    
    # Export
    top10_export_hs10 <- hs10_data_req_year %>%
      filter(tradeflow == "Export") %>%
      arrange(-value_exp) %>%
      head(10) %>%
      pull(hs_code)
    
    # Import
    top10_import_hs10 <- hs10_data_req_year %>%
      filter(tradeflow == "Import") %>%
      arrange(-value_imp) %>%
      head(10) %>%
      pull(hs_code)
    }
  
  # Export
  {
    # Separate the top 10
    export_top10 <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Export",
             hs_code %in% top10_export_hs10) %>%
      select(-month, -value_imp) %>%
      pivot_wider(names_from = month_name, values_from = value_exp) %>%
      mutate(yearly_total = rowSums(across(May:December), na.rm = T)) %>%
      # Need to add column for April 
      add_column(April = NA) %>%
      select(tradeflow, year, hs10_cat, hs4_cat, hs2_cat, 
             hs_code, April, May, June, July, August, September,
             October, November, December, yearly_total)
      arrange(-yearly_total)
    
    # Add the other items
    export_others <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Export",
             !(hs_code %in% top10_export_hs10)) %>%
      group_by(year, tradeflow, month, month_name) %>%
      summarise(value_exp = sum(value_exp)) %>%
      ungroup() %>%
      select(-month) %>%
      pivot_wider(names_from = month_name, values_from = value_exp) %>%
      mutate(yearly_total = rowSums(across(April:December), na.rm = T),
             hs10_cat = "Others", hs4_cat = "", hs2_cat = "", hs_code = "")
    
    # Add the total
    export_totals <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Export") %>%
      group_by(year, tradeflow, month, month_name) %>%
      summarise(value_exp = sum(value_exp)) %>%
      ungroup() %>%
      select(-month) %>%
      pivot_wider(names_from = month_name, values_from = value_exp)  %>%
      mutate(yearly_total = rowSums(across(April:December), na.rm = T),
             hs10_cat = "Total", hs4_cat = "", hs2_cat = "", hs_code = "")
    
    # Merge
    export_table <- rbind(export_top10, export_others, export_totals)
  }
  
  # Import
  {
    # Seperate the top 10
    import_top10 <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Import",
             hs_code %in% top10_import_hs10) %>%
      select(-month, -value_exp) %>%
      pivot_wider(names_from = month_name, values_from = value_imp) %>%
      mutate(yearly_total = rowSums(across(April:December), na.rm = T)) %>%
      arrange(-yearly_total)
    
    # Add the other items
    import_others <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Import",
             !(hs_code %in% top10_import_hs10)) %>%
      group_by(year, tradeflow, month, month_name) %>%
      summarise(value_imp = sum(value_imp)) %>%
      ungroup() %>%
      select(-month) %>%
      pivot_wider(names_from = month_name, values_from = value_imp) %>%
      mutate(yearly_total = rowSums(across(April:December), na.rm = T),
             hs10_cat = "Others", hs4_cat = "", hs2_cat = "", hs_code = "")
    
    # Add the total
    import_totals <- data_req %>%
      ungroup() %>%
      filter(tradeflow == "Import") %>%
      group_by(year, tradeflow, month, month_name) %>%
      summarise(value_imp = sum(value_imp)) %>%
      ungroup() %>%
      select(-month) %>%
      pivot_wider(names_from = month_name, values_from = value_imp) %>%
      mutate(yearly_total = rowSums(across(April:December), na.rm = T),
             hs10_cat = "Total", hs4_cat = "", hs2_cat = "", hs_code = "")
    
    # Merge
    import_table <- rbind(import_top10, import_others, import_totals)
  }
  
  # Save into Excel
  # Create workbook
  wb_request <- createWorkbook()
  # Add sheet
  addWorksheet(wb_request, "Trade_data") 
  
  # Add dataframe Export
  writeData(wb_request, sheet = "Trade_data", export_table,
            startCol = 1, startRow = 1,rowNames = FALSE)
  
  # Add dataframe Import
  writeData(wb_request, sheet = "Trade_data", import_table,
            startCol = 1, startRow = 15,rowNames = FALSE)
  
  # Save workbook to excel
  saveWorkbook(wb_request, "total/output/trade_export_import_summary_2020.xlsx", overwrite = TRUE)
  
  
  
}



##########################################################
############## COMBINING YEARS FOR FIGURES ###############
##########################################################

# HS2 cat first
{

  sunburst_cat_all <- plot_ly()
  
  # Import 2020
  sunburst_cat_all <- sunburst_cat_all %>%
    add_trace(
      data = filter(cat_first_20, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 0, row = 0))
  
  # Import 2021
  sunburst_cat_all <- sunburst_cat_all %>%
    add_trace(
      data = filter(cat_first_21, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 1, row = 0))
  
  # Import 2022
  sunburst_cat_all <- sunburst_cat_all %>%
    add_trace(
      data = filter(cat_first_22, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 2, row = 0))
  
  # Import 2020 no reg 9
  sunburst_cat_all <- sunburst_cat_all %>%
    add_trace(
      data = filter(cat_first_20_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 0, row = 1))
  
  # Import 2021 no reg 9
  sunburst_cat_all <- sunburst_cat_all %>%
    add_trace(
      data = filter(cat_first_21_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 1, row = 1))
  
  # Import 2022 no reg 9
  sunburst_cat_all <- sunburst_cat_all %>%
    add_trace(
      data = filter(cat_first_22_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 2, row = 1))
  
  # Export 2020
  sunburst_cat_all <- sunburst_cat_all %>%
    add_trace(
      data = filter(cat_first_20, tradeflow == "Export"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_fob,
      parents= ~parents,
      ids = ~ids,
      text = ~share_fob,
      domain = list(column = 0, row = 2))
  
  # Export 2021
  sunburst_cat_all <- sunburst_cat_all %>%
    add_trace(
      data = filter(cat_first_21, tradeflow == "Export"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_fob,
      parents= ~parents,
      ids = ~ids,
      text = ~share_fob,
      domain = list(column = 1, row = 2))
  
  # Export 2022
  sunburst_cat_all <- sunburst_cat_all %>%
    add_trace(
      data = filter(cat_first_22, tradeflow == "Export"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_fob,
      parents= ~parents,
      ids = ~ids,
      text = ~share_fob,
      domain = list(column = 2, row = 2))
  
  # Add subtitles
  # Update title
  annotations <- list( 
    list( 
      x = 0.15,  
      y = 1.0,  
      text = "2020",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE ,
      font = list(size = 15)
    ),  
    list( 
      x = 0.50,  
      y = 1,  
      text = "2021",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),  
    list( 
      x = .85,  
      y = 1.0,  
      text = "2022",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),
    list( 
      x = 0,  
      y = 0.85,  
      text = "Import",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),  
    list( 
      x = 0,  
      y = 0.5,  
      text = "Import (no Reg 9)",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),  
    list( 
      x = 0,  
      y = 0.15,  
      text = "Export",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ))
  
  sunburst_cat_all <- sunburst_cat_all %>%
    layout(
      annotations = annotations,
      grid = list(columns = 3, rows = 3),
      margin = list(l =100, r = 0, b = 0, t = 50))
  
  # Save in 1100, 600 format
  sunburst_cat_all
  
}

# HS2 cat + country
{
  
  sunburst_cat_country_all <- plot_ly()
  
  # Import 2020
  sunburst_cat_country_all <- sunburst_cat_country_all %>%
    add_trace(
      data = filter(cat_country_20, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 0, row = 0))
  
  # Import 2021
  sunburst_cat_country_all <- sunburst_cat_country_all %>%
    add_trace(
      data = filter(cat_country_21, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 1, row = 0))
  
  # Import 2022
  sunburst_cat_country_all <- sunburst_cat_country_all %>%
    add_trace(
      data = filter(cat_country_22, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 2, row = 0))
  
  # Import 2020 no reg 9
  sunburst_cat_country_all <- sunburst_cat_country_all %>%
    add_trace(
      data = filter(cat_country_20_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 0, row = 1))
  
  # Import 2021 no reg 9
  sunburst_cat_country_all <- sunburst_cat_country_all %>%
    add_trace(
      data = filter(cat_country_21_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 1, row = 1))
  
  # Import 2022 no reg 9
  sunburst_cat_country_all <- sunburst_cat_country_all %>%
    add_trace(
      data = filter(cat_country_22_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 2, row = 1))
  
  # Export 2020
  sunburst_cat_country_all <- sunburst_cat_country_all %>%
    add_trace(
      data = filter(cat_country_20, tradeflow == "Export"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_fob,
      parents= ~parents,
      ids = ~ids,
      text = ~share_fob,
      domain = list(column = 0, row = 2))
  
  # Export 2021
  sunburst_cat_country_all <- sunburst_cat_country_all %>%
    add_trace(
      data = filter(cat_country_21, tradeflow == "Export"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_fob,
      parents= ~parents,
      ids = ~ids,
      text = ~share_fob,
      domain = list(column = 1, row = 2))
  
  # Export 2022
  sunburst_cat_country_all <- sunburst_cat_country_all %>%
    add_trace(
      data = filter(cat_country_22, tradeflow == "Export"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_fob,
      parents= ~parents,
      ids = ~ids,
      text = ~share_fob,
      domain = list(column = 2, row = 2))
  
  # Add subtitles
  # Update title
  annotations <- list( 
    list( 
      x = 0.15,  
      y = 1.0,  
      text = "2020",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE ,
      font = list(size = 15)
    ),  
    list( 
      x = 0.50,  
      y = 1,  
      text = "2021",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),  
    list( 
      x = .85,  
      y = 1.0,  
      text = "2022",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),
    list( 
      x = 0,  
      y = 0.85,  
      text = "Import",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),  
    list( 
      x = 0,  
      y = 0.5,  
      text = "Import (no Reg 9)",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),  
    list( 
      x = 0,  
      y = 0.15,  
      text = "Export",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ))
  
  sunburst_cat_country_all <- sunburst_cat_country_all %>%
    layout(
      annotations = annotations,
      grid = list(columns = 3, rows = 3),
      margin = list(l =100, r = 0, b = 0, t = 50))
  
  # Save in 1100, 600 format
  sunburst_cat_country_all
  
}

# Country first
{
  
  sunburst_country_all <- plot_ly()
  
  # Import 2020
  sunburst_country_all <- sunburst_country_all %>%
    add_trace(
      data = filter(country_first_20, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 0, row = 0))
  
  # Import 2021
  sunburst_country_all <- sunburst_country_all %>%
    add_trace(
      data = filter(country_first_21, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 1, row = 0))
  
  # Import 2022
  sunburst_country_all <- sunburst_country_all %>%
    add_trace(
      data = filter(country_first_22, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 2, row = 0))
  
  # Import 2020 no reg 9
  sunburst_country_all <- sunburst_country_all %>%
    add_trace(
      data = filter(country_first_20_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 0, row = 1))
  
  # Import 2021 no reg 9
  sunburst_country_all <- sunburst_country_all %>%
    add_trace(
      data = filter(country_first_21_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 1, row = 1))
  
  # Import 2022 no reg 9
  sunburst_country_all <- sunburst_country_all %>%
    add_trace(
      data = filter(country_first_22_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 2, row = 1))
  
  # Export 2020
  sunburst_country_all <- sunburst_country_all %>%
    add_trace(
      data = filter(country_first_20, tradeflow == "Export"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_fob,
      parents= ~parents,
      ids = ~ids,
      text = ~share_fob,
      domain = list(column = 0, row = 2))
  
  # Export 2021
  sunburst_country_all <- sunburst_country_all %>%
    add_trace(
      data = filter(country_first_21, tradeflow == "Export"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_fob,
      parents= ~parents,
      ids = ~ids,
      text = ~share_fob,
      domain = list(column = 1, row = 2))
  
  # Export 2022
  sunburst_country_all <- sunburst_country_all %>%
    add_trace(
      data = filter(country_first_22, tradeflow == "Export"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_fob,
      parents= ~parents,
      ids = ~ids,
      text = ~share_fob,
      domain = list(column = 2, row = 2))
  
  # Add subtitles
  # Update title
  annotations <- list( 
    list( 
      x = 0.15,  
      y = 1.0,  
      text = "2020",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE ,
      font = list(size = 15)
    ),  
    list( 
      x = 0.50,  
      y = 1,  
      text = "2021",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),  
    list( 
      x = .85,  
      y = 1.0,  
      text = "2022",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),
    list( 
      x = 0,  
      y = 0.85,  
      text = "Import",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),  
    list( 
      x = 0,  
      y = 0.5,  
      text = "Import (no Reg 9)",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),  
    list( 
      x = 0,  
      y = 0.15,  
      text = "Export",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ))
  
  sunburst_country_all <- sunburst_country_all %>%
    layout(
      annotations = annotations,
      grid = list(columns = 3, rows = 3),
      margin = list(l =100, r = 0, b = 0, t = 50))
  
  # Save in 1100, 600 format
  sunburst_country_all
  
}

# country + HS2 cat
{
  
  sunburst_country_cat_all <- plot_ly()
  
  # Import 2020
  sunburst_country_cat_all <- sunburst_country_cat_all %>%
    add_trace(
      data = filter(country_cat_20, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 0, row = 0))
  
  # Import 2021
  sunburst_country_cat_all <- sunburst_country_cat_all %>%
    add_trace(
      data = filter(country_cat_21, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 1, row = 0))
  
  # Import 2022
  sunburst_country_cat_all <- sunburst_country_cat_all %>%
    add_trace(
      data = filter(country_cat_22, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 2, row = 0))
  
  # Import 2020 no reg 9
  sunburst_country_cat_all <- sunburst_country_cat_all %>%
    add_trace(
      data = filter(country_cat_20_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 0, row = 1))
  
  # Import 2021 no reg 9
  sunburst_country_cat_all <- sunburst_country_cat_all %>%
    add_trace(
      data = filter(country_cat_21_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 1, row = 1))
  
  # Import 2022 no reg 9
  sunburst_country_cat_all <- sunburst_country_cat_all %>%
    add_trace(
      data = filter(country_cat_22_noreg9, tradeflow == "Import"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_cif,
      parents= ~parents,
      ids = ~ids,
      text = ~share_cif,
      domain = list(column = 2, row = 1))
  
  # Export 2020
  sunburst_country_cat_all <- sunburst_country_cat_all %>%
    add_trace(
      data = filter(country_cat_20, tradeflow == "Export"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_fob,
      parents= ~parents,
      ids = ~ids,
      text = ~share_fob,
      domain = list(column = 0, row = 2))
  
  # Export 2021
  sunburst_country_cat_all <- sunburst_country_cat_all %>%
    add_trace(
      data = filter(country_cat_20, tradeflow == "Export"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_fob,
      parents= ~parents,
      ids = ~ids,
      text = ~share_fob,
      domain = list(column = 1, row = 2))
  
  # Export 2022
  sunburst_country_cat_all <- sunburst_country_cat_all %>%
    add_trace(
      data = filter(country_cat_20, tradeflow == "Export"),
      branchvalues="total",
      type='sunburst',
      labels = ~labels,
      values = ~values_fob,
      parents= ~parents,
      ids = ~ids,
      text = ~share_fob,
      domain = list(column = 2, row = 2))
  
  # Add subtitles
  # Update title
  annotations <- list( 
    list( 
      x = 0.15,  
      y = 1.0,  
      text = "2020",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE ,
      font = list(size = 15)
    ),  
    list( 
      x = 0.50,  
      y = 1,  
      text = "2021",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),  
    list( 
      x = .85,  
      y = 1.0,  
      text = "2022",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),
    list( 
      x = 0,  
      y = 0.85,  
      text = "Import",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),  
    list( 
      x = 0,  
      y = 0.5,  
      text = "Import (no Reg 9)",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ),  
    list( 
      x = 0,  
      y = 0.15,  
      text = "Export",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE,
      font = list(size = 15)
    ))
  
  sunburst_country_cat_all <- sunburst_country_cat_all %>%
    layout(
      annotations = annotations,
      grid = list(columns = 3, rows = 3),
      margin = list(l =100, r = 0, b = 0, t = 50))
  
  # Save in 1100, 600 format
  sunburst_country_cat_all
  
}
